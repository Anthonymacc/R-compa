<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparatif Running — Générateur</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚖️</text></svg>">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --green:#03CAA1;--green-dark:#02b59a;--dark:#0f172a;--gray:#64748b;
  --gray-border:#e2e8f0;--bg:#f8fafc;--white:#fff;--red:#ef4444;
  --yellow:#f59e0b;--radius:12px;--sidebar:240px;
}
body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--dark);display:flex;min-height:100vh;font-size:14px}
a{color:var(--green);text-decoration:none}
/* Sidebar */
#sidebar{width:var(--sidebar);background:var(--dark);color:#fff;display:flex;flex-direction:column;padding:16px;gap:4px;position:fixed;height:100vh;overflow-y:auto;z-index:10}
#sidebar .logo{font-size:18px;font-weight:800;padding:12px 8px 20px;color:var(--green)}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;border:none;background:none;color:#94a3b8;width:100%;text-align:left;font-size:13px;font-weight:500;transition:all .15s}
.nav-item:hover{background:rgba(255,255,255,.07);color:#fff}
.nav-item.active{background:rgba(3,202,161,.15);color:var(--green)}
.nav-item svg{width:16px;height:16px;flex-shrink:0}
.nav-sep{height:1px;background:rgba(255,255,255,.1);margin:8px 0}
.nav-section{font-size:11px;color:#475569;padding:8px 12px 4px;text-transform:uppercase;letter-spacing:.05em}
/* Main */
#main{margin-left:var(--sidebar);flex:1;display:flex;flex-direction:column;min-height:100vh}
.page-header{padding:24px 32px 0;border-bottom:1px solid var(--gray-border);background:var(--white)}
.page-header h1{font-size:22px;font-weight:800;margin-bottom:4px}
.page-header p{color:var(--gray);font-size:13px;padding-bottom:16px}
.page-content{padding:24px 32px;flex:1}
/* Cards */
.card{background:var(--white);border:1px solid var(--gray-border);border-radius:var(--radius);padding:20px}
.card+.card{margin-top:16px}
.card-title{font-size:15px;font-weight:700;margin-bottom:12px}
/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s;text-decoration:none}
.btn-primary{background:var(--green);color:#083b33}
.btn-primary:hover{background:var(--green-dark)}
.btn-secondary{background:var(--gray-border);color:var(--dark)}
.btn-secondary:hover{background:#cbd5e1}
.btn-danger{background:#fee2e2;color:var(--red)}
.btn-danger:hover{background:#fecaca}
.btn-sm{padding:5px 10px;font-size:12px}
.btn-ghost{background:none;color:var(--gray);border:1px solid var(--gray-border)}
.btn-ghost:hover{background:var(--bg)}
.btn[disabled]{opacity:.5;cursor:not-allowed}
/* Forms */
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--gray);margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em}
.form-input{width:100%;padding:8px 12px;border:1px solid var(--gray-border);border-radius:8px;font-size:13px;font-family:inherit;background:var(--white);color:var(--dark);transition:border-color .15s}
.form-input:focus{outline:none;border-color:var(--green)}
select.form-input{cursor:pointer}
textarea.form-input{resize:vertical;min-height:80px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
/* Modals */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--white);border-radius:16px;width:100%;max-width:680px;max-height:90vh;overflow-y:auto;padding:24px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-header h2{font-size:17px;font-weight:800}
.modal-close{background:none;border:none;cursor:pointer;color:var(--gray);font-size:20px;line-height:1;padding:4px}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--gray-border)}
/* Badges */
.badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;font-size:11px;font-weight:700}
.badge-green{background:rgba(3,202,161,.12);color:#035e4d}
.badge-yellow{background:#fef3c7;color:#92400e}
.badge-red{background:#fee2e2;color:#991b1b}
.badge-gray{background:#f1f5f9;color:#475569}
.badge-blue{background:#dbeafe;color:#1e40af}
/* Status dot */
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.dot-pending{background:#cbd5e1}
.dot-generating{background:var(--yellow);animation:pulse 1s infinite}
.dot-generated{background:#60a5fa}
.dot-edited{background:var(--yellow)}
.dot-validated{background:var(--green)}
.dot-error{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
/* Progress */
.progress-bar-bg{height:6px;background:var(--gray-border);border-radius:999px;overflow:hidden;margin:16px 0}
.progress-bar-fill{height:100%;background:var(--green);border-radius:999px;transition:width .4s ease}
.step-list{display:flex;flex-direction:column;gap:8px}
.step-row{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:8px;background:var(--bg);border:1px solid var(--gray-border)}
.step-row.active{border-color:var(--green);background:rgba(3,202,161,.05)}
.step-row.done{opacity:.7}
.step-dot{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0}
.step-dot.pending{background:var(--gray-border);color:var(--gray)}
.step-dot.active{background:var(--green);color:#fff;animation:pulse 1s infinite}
.step-dot.done{background:rgba(3,202,161,.15);color:var(--green)}
.step-dot.error{background:#fee2e2;color:var(--red)}
/* Product card list */
.product-list{display:flex;flex-direction:column;gap:8px}
.product-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--bg);border:1px solid var(--gray-border);border-radius:10px;cursor:grab}
.product-item:active{cursor:grabbing}
.product-item img{width:48px;height:48px;object-fit:contain;border-radius:6px;background:#fff;border:1px solid var(--gray-border)}
.product-item-info{flex:1}
.product-item-name{font-weight:700;font-size:13px}
.product-item-meta{font-size:12px;color:var(--gray)}
.product-item-actions{display:flex;gap:6px}
/* Tabs */
.tabs{display:flex;gap:2px;background:var(--bg);border:1px solid var(--gray-border);border-radius:10px;padding:3px;margin-bottom:20px}
.tab-btn{flex:1;padding:8px;border:none;background:none;cursor:pointer;border-radius:7px;font-size:13px;font-weight:600;color:var(--gray);transition:all .15s}
.tab-btn.active{background:var(--white);color:var(--dark);box-shadow:0 1px 3px rgba(0,0,0,.1)}
/* Split view */
.split-view{display:grid;grid-template-columns:1fr 1fr;gap:16px;height:500px}
.split-pane{display:flex;flex-direction:column;gap:8px}
.split-pane label{font-size:12px;font-weight:700;color:var(--gray);text-transform:uppercase}
.split-pane iframe,.split-pane textarea{flex:1;width:100%;border:1px solid var(--gray-border);border-radius:8px;resize:none;font-size:12px;font-family:monospace;padding:10px}
/* Checks */
.check-list{display:flex;flex-direction:column;gap:6px}
.check-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;font-size:13px}
.check-item.ok{background:rgba(3,202,161,.07);color:#035e4d}
.check-item.warn{background:#fef3c7;color:#92400e}
.check-item.err{background:#fee2e2;color:#991b1b}
/* Blocs overview table */
.blocs-table{width:100%;border-collapse:collapse;font-size:13px}
.blocs-table th{text-align:left;padding:8px 10px;background:var(--bg);border-bottom:2px solid var(--gray-border);font-size:11px;text-transform:uppercase;color:var(--gray);white-space:nowrap}
.blocs-table td{padding:8px 10px;border-bottom:1px solid var(--gray-border);vertical-align:middle}
.blocs-table tr:hover td{background:var(--bg)}
.bloc-cell{display:flex;align-items:center;gap:6px}
.bloc-dot-btn{cursor:pointer;display:inline-flex;align-items:center;gap:4px;padding:3px 7px;border-radius:6px;border:1px solid var(--gray-border);font-size:11px;background:var(--white);transition:all .15s}
.bloc-dot-btn:hover{border-color:var(--green)}
/* Stats */
.stats-row{display:flex;gap:12px;flex-wrap:wrap}
.stat-card{flex:1;min-width:120px;padding:14px 16px;background:var(--white);border:1px solid var(--gray-border);border-radius:10px}
.stat-card .val{font-size:24px;font-weight:800;color:var(--green)}
.stat-card .lbl{font-size:12px;color:var(--gray);margin-top:2px}
/* Placeholder list */
.placeholder-list{display:flex;flex-direction:column;gap:6px}
.placeholder-row{display:flex;align-items:center;gap:8px}
.placeholder-row .ph-key{font-size:12px;font-family:monospace;background:var(--bg);border:1px solid var(--gray-border);border-radius:6px;padding:4px 8px;white-space:nowrap;min-width:200px}
.placeholder-row .form-input{flex:1}
/* Home grid */
.comp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.comp-card{background:var(--white);border:1px solid var(--gray-border);border-radius:12px;padding:16px;cursor:pointer;transition:all .2s}
.comp-card:hover{border-color:var(--green);box-shadow:0 4px 12px rgba(3,202,161,.15)}
.comp-card-title{font-weight:700;font-size:15px;margin-bottom:6px}
.comp-card-meta{font-size:12px;color:var(--gray);display:flex;gap:10px;flex-wrap:wrap}
/* Checkboxes */
.checkbox-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.checkbox-item{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px}
.checkbox-item input{accent-color:var(--green)}
/* Alert */
.alert{padding:12px 16px;border-radius:8px;font-size:13px;margin-bottom:12px}
.alert-info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
.alert-warn{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}
/* Settings page */
.settings-section{margin-bottom:24px}
.settings-section h3{font-size:14px;font-weight:700;margin-bottom:12px;color:var(--gray);text-transform:uppercase;font-size:11px;letter-spacing:.05em}
/* Responsive */
@media(max-width:768px){
  #sidebar{width:200px}
  #main{margin-left:200px}
  .form-grid,.form-grid-3{grid-template-columns:1fr}
  .split-view{grid-template-columns:1fr;height:auto}
}
/* Drag ghost */
.product-item.dragging{opacity:.4}
/* Empty state */
.empty-state{text-align:center;padding:48px 24px;color:var(--gray)}
.empty-state h3{font-size:18px;font-weight:700;margin-bottom:8px;color:var(--dark)}
/* Disabled select options */
select.form-input option:disabled{color:#94a3b8;background:#f1f5f9;font-style:italic}
</style>
</head>
<body>
<div id="sidebar"></div>
<div id="main"></div>
<div id="modal-root"></div>

<script>
// ─── CONSTANTS ───────────────────────────────────────────────────────────────
const DB_KEY = 'comparatif_running_db';
const WP_SITES = {
  'Run Evasion': { url: 'https://run-evasion.fr', postType: 'blc-product-review' }
};
const THEMATIQUES = ['general','par-marque','par-budget','par-profil','marathon','semi-marathon','10km','5km','debutant','pronation','supination','coureur-lourd','amorti','plaque-carbone'];
const THEMATIQUE_LABELS = {general:'Général','par-marque':'Par marque','par-budget':'Par budget','par-profil':'Par profil',marathon:'Marathon','semi-marathon':'Semi-marathon','10km':'10 km','5km':'5 km',debutant:'Débutant',pronation:'Pronation',supination:'Supination','coureur-lourd':'Coureur lourd (+85 kg)','amorti':'Meilleur amorti','plaque-carbone':'Plaque carbone'};
const MARQUES = ['Adidas','Asics','Brooks','On Running','New Balance','Nike','Hoka One','Mizuno','Saucony','Altra Running','Salomon','Puma'];
const USAGES_LIST = ['Footing','Endurance','Tempo','Sorties longues','Marathon','Semi-marathon','10 km','5 km','Récupération','Compétition'];

const THEMATIQUE_CONTEXT = {
  'general': '',
  'par-marque': `CONTEXTE THÉMATIQUE : Comparatif centré sur une marque spécifique.
Consignes spécifiques :
- Mets en avant l'ADN de la marque, sa philosophie et son histoire dans le running
- Compare l'évolution des modèles de la marque entre eux
- Explique ce qui distingue cette marque de ses concurrents directs
- Mentionne les technologies propriétaires (ex : FLYKNIT chez Nike, GEL chez Asics, PWRRUN chez Saucony)
- Aide le lecteur à choisir le bon modèle DANS cette marque selon son profil`,

  'par-budget': `CONTEXTE THÉMATIQUE : Comparatif organisé par gamme de prix.
Consignes spécifiques :
- Structure la présentation par tranches de prix (< 100€, 100-150€, 150-200€, > 200€)
- Insiste sur le rapport qualité/prix de chaque modèle
- Mentionne les alternatives moins chères quand elles existent
- Indique clairement ce que chaque gamme de prix apporte en plus
- Aide le lecteur à investir au juste prix selon sa pratique`,

  'par-profil': `CONTEXTE THÉMATIQUE : Comparatif ciblant un profil de coureur spécifique.
Consignes spécifiques :
- Adapte les recommandations au niveau, à la fréquence et aux objectifs du coureur
- Identifie les profils types : débutant occasionnel, régulier 2-3x/semaine, compétiteur, ultra-trailer
- Pour chaque produit, indique le profil idéal
- Mentionne le kilométrage hebdomadaire adapté à chaque modèle`,

  'marathon': `CONTEXTE THÉMATIQUE : Comparatif spécialisé chaussures de marathon (42,195 km).
Consignes spécifiques :
- Concentre-toi sur l'amorti longue distance et le confort après 30 km
- Évalue le retour d'énergie et la plaque carbone/fibre si présente
- Mentionne le poids comme critère clé (chaque gramme compte sur 42 km)
- Parle de la transition talon-pointe et du drop adapté au marathon
- Aborde le maintien et le verrouillage du pied sur les derniers kilomètres
- Compare les performances sur sol mouillé et par temps chaud
- Mentionne les records ou performances réalisés avec ces modèles
- Conseille sur la stratégie : chaussure d'entraînement marathon vs chaussure de course le jour J`,

  'semi-marathon': `CONTEXTE THÉMATIQUE : Comparatif spécialisé chaussures de semi-marathon (21,1 km).
Consignes spécifiques :
- Mets en avant l'équilibre vitesse/confort (le semi demande plus de rythme que le marathon)
- Évalue la réactivité et le dynamisme de chaque modèle
- Le poids doit être faible mais l'amorti reste important pour 21 km
- Mentionne les chaussures polyvalentes entraînement + jour de course
- Aborde le tempo soutenu (allure 4:00 à 5:30/km selon le niveau)
- Conseille selon le temps visé : sub 1h30, sub 1h45, sub 2h, finisher`,

  '10km': `CONTEXTE THÉMATIQUE : Comparatif spécialisé chaussures pour le 10 km.
Consignes spécifiques :
- Privilégie la réactivité et le dynamisme (effort de 30-50 min à haute intensité)
- Évalue la légèreté comme critère principal
- Le drop peut être plus bas (4-6mm) pour favoriser l'attaque médio-pied
- Mentionne la relance et la nervosité de la semelle
- Moins besoin d'amorti que sur marathon — plus besoin de tonicité
- Conseille selon le niveau : sub 35 min, sub 40, sub 45, sub 50, sub 60
- Aborde l'accroche au sol pour les 10 km sur route et les départs rapides`,

  '5km': `CONTEXTE THÉMATIQUE : Comparatif spécialisé chaussures pour le 5 km.
Consignes spécifiques :
- Concentre-toi sur la vitesse pure et la performance brute
- Privilégie les racing flats / chaussures de compétition ultra-légères (< 200g)
- Le confort passe après la performance sur cette distance
- Évalue le grip et l'accroche pour les départs explosifs
- Mentionne la réactivité maximale de la semelle
- Drop bas (0-4mm) pour une foulée naturelle et rapide
- Conseille selon le niveau : sub 16 min, sub 18, sub 20, sub 25
- Aborde la durabilité (ces chaussures s'usent vite, combien de courses ?)`,

  'debutant': `CONTEXTE THÉMATIQUE : Comparatif pour coureurs débutants.
Consignes spécifiques :
- Mets en avant le confort et la tolérance avant tout (pas la performance)
- Privilégie l'amorti protecteur pour les articulations pas encore habituées
- Recommande des modèles stables et polyvalents
- Mentionne le rapport qualité/prix (un débutant ne veut pas investir 250€)
- Donne des conseils sur le choix de la pointure et l'essayage
- Aborde la progressivité : commencer avec plus d'amorti, évoluer ensuite
- Parle des erreurs fréquentes (chaussure trop petite, trop de drop, trop légère)`,

  'pronation': `CONTEXTE THÉMATIQUE : Comparatif spécialisé chaussures pour coureurs pronateurs.
Consignes spécifiques :
- Explique clairement ce qu'est la pronation (rotation interne du pied à l'appui)
- Distingue les niveaux : pronation légère, modérée et sévère
- Évalue les technologies anti-pronation : guide rails (Brooks), Dynamic DuoMax (Asics), medial post, double densité
- Mentionne le test de la foulée et l'analyse podologique
- Classe les modèles par niveau de correction : support léger vs stabilité maximale
- Conseille sur le passage d'une chaussure neutre à une chaussure de stabilité
- Aborde les blessures liées à la pronation : périostite, fasciite, genou du coureur`,

  'supination': `CONTEXTE THÉMATIQUE : Comparatif spécialisé chaussures pour coureurs supinateurs.
Consignes spécifiques :
- Explique clairement ce qu'est la supination (appui excessif sur l'extérieur du pied)
- Mentionne que c'est moins courant que la pronation (5-10% des coureurs)
- Recommande des chaussures neutres avec amorti renforcé (PAS de chaussures de stabilité)
- Évalue la flexibilité et la souplesse de la semelle (le pied supinateur a besoin de liberté)
- Mentionne l'amorti côté externe comme critère principal
- Conseille sur les semelles orthopédiques complémentaires
- Aborde l'usure typique de la semelle d'un supinateur (extérieur du talon)
- Parle des blessures liées : entorse, syndrome de la bandelette iliotibiale`,

  'coureur-lourd': `CONTEXTE THÉMATIQUE : Comparatif spécialisé chaussures pour coureurs lourds (+85 kg).
Consignes spécifiques :
- Mets en avant l'amorti renforcé et la durabilité comme critères n°1
- Évalue la densité de la mousse (les mousses trop souples s'écrasent sous le poids)
- Privilégie les semelles épaisses avec bon retour d'énergie qui ne "bottent" pas
- Mentionne la stabilité : un coureur lourd a plus de risques de pronation sous le poids
- Évalue la durabilité de la semelle extérieure (gomme, caoutchouc soufflé vs carbone)
- Parle du drop : un drop de 8-10mm est souvent plus confortable pour les gabarits lourds
- Aborde la protection des articulations (genoux, chevilles, dos)
- Mentionne le poids de la chaussure elle-même (un coureur lourd supporte mieux une chaussure plus lourde mais plus protectrice)
- Conseille sur la fréquence de remplacement (plus rapide pour les coureurs lourds, tous les 600-800 km)`,

  'amorti': `CONTEXTE THÉMATIQUE : Comparatif des meilleures chaussures avec un bon amorti.
Consignes spécifiques :
- Compare les technologies d'amorti : mousse (EVA, TPU, PEBA), gel, air, mécanique
- Classe les modèles par niveau d'amorti : moelleux/maximaliste vs ferme/réactif
- Évalue le retour d'énergie (un bon amorti absorbe ET renvoie)
- Mentionne les marques leaders en amorti : Hoka (maximaliste), Asics (GEL), Nike (ZoomX), New Balance (FuelCell)
- Distingue amorti au talon vs amorti avant-pied
- Parle du stack height (hauteur de semelle) et de son impact
- Aborde le compromis amorti vs stabilité vs poids
- Mentionne les sensations : plush/moelleux vs dynamique/réactif
- Conseille selon l'usage : amorti max pour les sorties longues, plus ferme pour le tempo`,

  'plaque-carbone': `CONTEXTE THÉMATIQUE : Comparatif des chaussures à plaque carbone.
Consignes spécifiques :
- Explique le rôle de la plaque carbone : effet levier, rigidité en torsion, propulsion
- Mentionne l'historique : Nike Vaporfly qui a révolutionné le marathon
- Compare les types de plaques : carbone pleine, carbone partielle, fibre de verre, Pebax
- Évalue l'association plaque + mousse (la plaque seule ne suffit pas, c'est le combo qui compte)
- Classe par distance optimale : plaque pour marathon, pour semi, pour 10km
- Mentionne les règles World Athletics (épaisseur max 40mm, une seule plaque)
- Aborde la durabilité : combien de km avant que la plaque perde son efficacité (300-500 km)
- Parle du prix (généralement 200-280€) et du rapport investissement/performance
- Conseille sur le type de coureur : la plaque carbone n'est pas pour tout le monde (il faut un minimum de vitesse pour l'activer)
- Mentionne les alternatives : plaques nylon, fibre de verre, tiges de carbone`
};
const STEP_LABELS = [
  'Introduction + Méthodologie','Tableau HTML triable','Fiches produit (×N)','Blocs image (local)',
  'Paragraphes descriptifs (×N)','Blocs CTA (local)','Maillage interne (×N)',
  'Sections éducatives','Conclusion + Top 3','FAQ HTML'
];

// ─── TEMPLATES ───────────────────────────────────────────────────────────────
const TEMPLATE_TABLEAU_CSS = `.cc-table-card{width:min(1100px,100%);background:#fff;border-radius:14px;box-shadow:0 12px 30px rgba(2,6,23,.08);overflow:hidden;border:1px solid #e9eef5;margin:0 auto}.cc-table-scroll{overflow:auto;max-height:70vh;-webkit-overflow-scrolling:touch}table.cc-table{width:100%;border-collapse:collapse;table-layout:auto;font:14px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:#0f172a;background:#fff}.cc-table th,.cc-table td{padding:12px;text-align:left;white-space:nowrap}.cc-table thead th{position:sticky;top:0;z-index:2;background:linear-gradient(180deg,#03CAA1,#02b59a);color:#fff;font-weight:700;letter-spacing:.2px;cursor:pointer;user-select:none;border-bottom:1px solid rgba(0,0,0,.12)}.cc-th-inner{display:inline-flex;align-items:center;gap:8px}.cc-sort-icon{width:14px;height:14px;opacity:.8;transition:transform .18s ease}.cc-table thead th[aria-sort="ascending"] .cc-sort-icon{transform:rotate(180deg)}.cc-table tbody tr:nth-child(even){background:#f8fafc}.cc-table tbody tr:hover{background:#f0fbf8}.cc-is-sorted{box-shadow:inset 0 -2px 0 0 #03CAA1}.cc-link{color:#03CAA1;font-weight:600;text-decoration:none;border-bottom:1px dashed rgba(3,202,161,.6)}.cc-link:hover{text-decoration:underline}.cc-copy{margin-left:8px;border:none;background:#f3f4f6;color:#0f172a;border-radius:8px;padding:6px;cursor:pointer}.cc-copy:hover{background:#e5e7eb}.cc-copy[aria-pressed="true"]{background:#03CAA1;color:#fff}.cc-badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-weight:700;font-size:12px}.cc-badge-score{background:rgba(3,202,161,.14);color:#035e4d}.cc-badge-price{background:#eef2f7;color:#334155}@media(max-width:720px){.cc-table{min-width:640px;font-size:13px}.cc-table th,.cc-table td{padding:10px}}`;

const TEMPLATE_FAQ_CSS = `:root{--re-accent:#00C69D}*{box-sizing:border-box}.re-faq{background:#fff;border-radius:14px;padding:10px;box-shadow:0 8px 24px rgba(2,8,23,.06);border:1px solid #E8EDF2}.re-faq__title{font-size:1.05rem;font-weight:800;margin:8px 8px 12px;text-align:center}.re-faq__item{border:1px solid #E8EDF2;border-left:4px solid transparent;border-radius:12px;overflow:hidden;background:#fff;margin:12px 8px;transition:border-color .2s ease,box-shadow .2s ease}.re-faq__item[open]{border-left-color:var(--re-accent);box-shadow:0 4px 14px rgba(0,0,0,.06)}.re-faq__item summary{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 18px;font-weight:800;color:#0F172A}.re-faq__item summary::-webkit-details-marker{display:none}.re-faq__item summary::after{content:"▾";font-size:18px;line-height:1;transition:transform .25s ease;color:var(--re-accent)}.re-faq__item[open] summary::after{transform:rotate(180deg)}.re-faq__item summary h3{margin:0;font-weight:800;flex:1}.re-faq__content{padding:14px 18px 18px;background:#fff;border-top:1px solid #EEF2F6;color:#334155}.re-faq__content p{margin:0 0 10px}.re-faq a{color:var(--re-accent);text-decoration:underline}`;

// ─── PROMPTS ─────────────────────────────────────────────────────────────────
const SYS_COMP = `Tu es un rédacteur expert spécialisé en running et chaussures de course à pied. Tu rédiges des comparatifs pour le blog Run Evasion. Ton ton est expert mais accessible. Règles : mots clés importants en <strong>, max 10 <strong> par paragraphe, format WordPress (<!-- wp:paragraph -->, <!-- wp:heading -->), pas de majuscule après les deux-points, pas de majuscule à chaque mot dans les titres. Génère uniquement du HTML WordPress valide, aucun commentaire ni markdown en dehors des balises wp.`;

const DEFAULT_PROMPTS = {
  sys: SYS_COMP,
  p_intro: (titre, csv, nb) => `Rédige l'introduction et la section méthodologie pour un comparatif intitulé "${titre}" comparant ${nb} modèles de chaussures de running.

Voici les produits en CSV :
${csv}

Structure à produire (format WordPress) :
1. Un bloc <!-- wp:paragraph --> d'accroche (2-3 phrases percutantes sur le sujet)
2. Un bloc <!-- wp:heading {"level":2} --> "Comment nous avons sélectionné ces modèles"
3. 2-3 blocs <!-- wp:paragraph --> expliquant la méthodologie (critères : note, rapport qualité/prix, profils utilisateurs, tests terrain)
4. Un bloc <!-- wp:heading {"level":2} --> "Résumé rapide"
5. Un bloc <!-- wp:paragraph --> résumant les meilleurs choix par profil

Génère uniquement le HTML WordPress, sans markdown autour.`,

  p_tableau: (csv, template_css) => `Génère le tableau HTML comparatif triable pour ces chaussures de running.

Données CSV :
${csv}

Template CSS à utiliser (copie exactement ce CSS dans un bloc <style>) :
${template_css}

Instructions :
- Crée un bloc <!-- wp:html --> complet avec <style>, <div class="cc-table-card">, <table class="cc-table" data-initial-sort="1:desc">, le tbody avec une ligne par produit, et le <script> de tri
- Pour chaque produit : colonne Modèle (marque + nom), Note (badge cc-badge-score), Prix (badge cc-badge-price), Meilleure offre (lien cc-link vers urlAffilie + bouton cc-copy)
- Inclus le script JS de tri complet (collator fr, parseNumber, initTable)
- Ferme avec <!-- /wp:html -->`,

  p_fiche: (nom, marque, csv_produit, template_css) => `Génère la fiche produit HTML complète pour la ${marque} ${nom}.

Données du produit :
${csv_produit}

Utilise exactement le template CSS des fiches produit (variables CSS --accent #01C59D, design card avec image + partenaire + contenu). Structure :
- <!-- wp:html -->
- <article class="product-block"> avec <style> inline complet
- grid : media | partner | content
- Inclus : titre, prix, note étoiles (CSS gradient), specs (poids/drop/mousse), chips usage, pros/cons, bouton "Voir le test" si urlTest présent
- JSON-LD Product complet (name, brand, image, description, aggregateRating, offers)
- <!-- /wp:html -->

Pour la description courte du JSON-LD, synthétise en 1 phrase les points forts.`,

  p_paragraphe: (nom, marque, csv_produit) => `Rédige un paragraphe descriptif de 150-200 mots pour la ${marque} ${nom} dans un comparatif de chaussures de running.

Données :
${csv_produit}

Format :
<!-- wp:heading {"level":2} -->
<h2 class="wp-block-heading">${marque} ${nom} : [sous-titre accrocheur]</h2>
<!-- /wp:heading -->
<!-- wp:paragraph -->
<p>[Paragraphe descriptif avec points forts en <strong>, usage idéal, verdict]</p>
<!-- /wp:paragraph -->

Commence directement par le bloc heading.`,

  p_maillage: (nom, marque, articles) => `Génère un bloc de maillage interne pour la ${marque} ${nom} dans un comparatif running.

Articles disponibles sur le site :
${articles || 'Aucun article fourni - utilise des placeholders {{URL_TEST_MODELE}}, {{URL_COMPARATIF_MARQUE}}'}

Génère un bloc <!-- wp:paragraph --> avec 2-3 liens internes naturels vers des articles connexes. Si les URLs ne sont pas connues, utilise des placeholders entre {{doubles accolades}} que l'utilisateur remplacera.
Exemple : <a href="{{URL_TEST_ASICS_GT2000}}">notre test complet de l'Asics GT-2000</a>

Format : <!-- wp:paragraph --><p>...</p><!-- /wp:paragraph -->`,

  p_educatif: (csv, modeles) => `Rédige 2-3 sections éducatives pour un comparatif de chaussures de running.

Modèles comparés : ${modeles}
CSV complet : ${csv}

Sections à rédiger (format WordPress) :
1. <!-- wp:heading {"level":2} --> "Comment choisir ses chaussures de running ?"
   - 3-4 paragraphes sur : type de foulée, terrain, distance, budget
2. <!-- wp:heading {"level":2} --> "Tableau des profils et recommandations"
   - Un paragraphe par profil : débutant, régulier, compétiteur, trail
3. <!-- wp:heading {"level":2} --> "Les critères techniques à connaître"
   - Drop, mousse, poids, stabilité : explications accessibles

Génère uniquement les blocs WordPress, sans markdown autour.`,

  p_conclusion: (csv) => `Rédige la conclusion et le top 3 pour ce comparatif de chaussures de running.

CSV des produits (trié par note décroissante) :
${csv}

Structure :
1. <!-- wp:heading {"level":2} --> "Notre verdict final"
2. <!-- wp:paragraph --> Synthèse de 100 mots
3. <!-- wp:heading {"level":2} --> "Top 3 de notre sélection"
4. Pour chaque position du podium : <!-- wp:heading {"level":3} --> + <!-- wp:paragraph --> avec justification
5. <!-- wp:paragraph --> Phrase de clôture avec appel à l'action

Utilise les vraies données du CSV pour le podium. Génère uniquement les blocs WordPress.`,

  p_faq: (titre, modeles, template_css) => `Génère une FAQ HTML complète pour le comparatif "${titre}".

Modèles inclus : ${modeles}

CSS à utiliser (copie dans <style>) :
${template_css}

Génère exactement 6 questions/réponses pertinentes sur :
1. Comment choisir entre ces modèles
2. Quel modèle pour quel profil de coureur
3. Question sur le drop ou la mousse
4. Question sur le prix / rapport qualité-prix
5. Question sur la durabilité ou l'entretien
6. Question sur les sites où acheter

Format :
<!-- wp:html -->
<style>[CSS]</style>
<h2>FAQ : ${titre}</h2>
<section class="re-faq" aria-label="FAQ ${titre}">
  <details class="re-faq__item">
    <summary><h3>[Question]</h3></summary>
    <div class="re-faq__content"><p>[Réponse détaillée]</p></div>
  </details>
  ... (6 items)
</section>
<!-- /wp:html -->`
};

// ─── DB ───────────────────────────────────────────────────────────────────────
function loadDB() {
  try {
    return JSON.parse(localStorage.getItem(DB_KEY)) || defaultDB();
  } catch { return defaultDB(); }
}
function defaultDB() {
  return { apiKey: '', wpCreds: {}, comparatifs: [], customPrompts: {} };
}
function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

let db = loadDB();

// ─── STATE ────────────────────────────────────────────────────────────────────
const state = {
  page: 'home',
  compId: null,
  reviewTab: 0,
  currentBlockKey: null,  // 'intro'|'tableau'|'educatif'|'conclusion'|'faq'|'fiches:1'|...
  stepStatus: Array(10).fill('pending'),  // for progress page
  generating: false,
  toast: null,
  liveUsage: { inputTokens: 0, outputTokens: 0, cost: 0, apiCalls: 0 },
};

// ─── HELPERS ─────────────────────────────────────────────────────────────────
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function uid() { return Date.now() + Math.random().toString(36).slice(2); }
function wordCount(html) { return (html||'').replace(/<[^>]+>/g,' ').split(/\s+/).filter(Boolean).length; }
function getComp() { return db.comparatifs.find(c => c.id === state.compId) || null; }

function showToast(msg, type='ok') {
  state.toast = { msg, type };
  render();
  setTimeout(() => { state.toast = null; render(); }, 3000);
}

function copyText(text) {
  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(text).then(() => showToast('Copié dans le presse-papiers !'));
  } else {
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('Copié !');
  }
}

function produitsToCSV(produits) {
  const cols = ['nom','marque','prix','note','poids','drop','mousse','usages','pointFort1','pointFort2','pointFaible','urlAffilie','urlTest'];
  const header = cols.join(',');
  const rows = produits.map(p => cols.map(k => {
    const v = k === 'usages' ? (p.usages||[]).join('|') : (p[k]||'');
    return `"${String(v).replace(/"/g,'""')}"`;
  }).join(','));
  return [header, ...rows].join('\n');
}

function produitToCSV(p) {
  const cols = ['nom','marque','prix','note','poids','drop','mousse','usages','pointFort1','pointFort2','pointFaible','urlAffilie','urlTest'];
  const header = cols.join(',');
  const row = cols.map(k => {
    const v = k === 'usages' ? (p.usages||[]).join('|') : (p[k]||'');
    return `"${String(v).replace(/"/g,'""')}"`;
  }).join(',');
  return header + '\n' + row;
}

function newBlocs(produits) {
  const blocs = {
    intro:{ html:'', status:'pending' }, tableau:{ html:'', status:'pending' },
    educatif:{ html:'', status:'pending' }, conclusion:{ html:'', status:'pending' },
    faq:{ html:'', status:'pending' },
    fiches:{}, images:{}, paragraphes:{}, cta:{}, maillage:{}
  };
  produits.forEach(p => {
    blocs.fiches[p.id] = { html:'', status:'pending' };
    blocs.images[p.id] = { html:'', status:'pending' };
    blocs.paragraphes[p.id] = { html:'', status:'pending' };
    blocs.cta[p.id] = { html:'', status:'pending' };
    blocs.maillage[p.id] = { html:'', status:'pending', placeholders:{} };
  });
  return blocs;
}

function isProduitComplete(p) {
  const required = ['nom','marque','prix','note','poids','drop','mousse','pointFort1','pointFort2','pointFaible','urlImage','urlAffilie'];
  return required.every(k => p[k] !== undefined && p[k] !== '') && (p.usages||[]).length > 0;
}

function getPrompt(key) {
  return db.customPrompts[key] || DEFAULT_PROMPTS[key];
}

// ─── PRICING ─────────────────────────────────────────────────────────────────
const MODEL_PRICING = {
  'claude-sonnet-4-5': { input: 3, output: 15 },   // $/M tokens
  'claude-haiku-4-5':  { input: 0.80, output: 4 },
};
const EUR_PER_USD = 0.93;

function calcCost(inputTokens, outputTokens, model) {
  const p = MODEL_PRICING[model] || MODEL_PRICING['claude-sonnet-4-5'];
  return ((inputTokens * p.input + outputTokens * p.output) / 1_000_000) * EUR_PER_USD;
}

function formatCost(eur) {
  return eur < 0.01 ? '<0,01€' : eur.toFixed(2).replace('.', ',') + '€';
}

// ─── API ──────────────────────────────────────────────────────────────────────
async function callClaude(system, prompt, model='claude-sonnet-4-5') {
  const apiKey = db.apiKey;
  if (!apiKey) throw new Error('Clé API Claude manquante. Va dans Paramètres.');
  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model,
      max_tokens: 8192,
      system,
      messages: [{ role: 'user', content: prompt }]
    })
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(`API Claude erreur ${res.status}: ${err?.error?.message || res.statusText}`);
  }
  const data = await res.json();
  // Track usage
  const usage = data.usage || {};
  const tokIn = usage.input_tokens || 0;
  const tokOut = usage.output_tokens || 0;
  const cost = calcCost(tokIn, tokOut, model);
  // Accumulate in current comp
  const comp = getComp();
  if (comp) {
    if (!comp.usage) comp.usage = { inputTokens: 0, outputTokens: 0, cost: 0, apiCalls: 0 };
    comp.usage.inputTokens += tokIn;
    comp.usage.outputTokens += tokOut;
    comp.usage.cost += cost;
    comp.usage.apiCalls += 1;
    saveDB();
  }
  // Also track in state for real-time display
  state.liveUsage.inputTokens += tokIn;
  state.liveUsage.outputTokens += tokOut;
  state.liveUsage.cost += cost;
  state.liveUsage.apiCalls += 1;

  return data.content[0].text;
}

// ─── PROMPT HELPERS ───────────────────────────────────────────────────────────
function applyTemplate(tpl, vars) {
  return tpl.replace(/\$\{(\w+)\}/g, (_, k) => vars[k] !== undefined ? String(vars[k]) : '');
}
function getPromptDefaultText(key) {
  const fn = DEFAULT_PROMPTS[key];
  if (!fn) return '';
  if (typeof fn === 'string') return fn;
  const src = fn.toString();
  const bt = src.indexOf('`');
  const lb = src.lastIndexOf('`');
  return (bt >= 0 && lb > bt) ? src.slice(bt + 1, lb) : src;
}
function callPrompt(key, vars) {
  const custom = db.customPrompts?.[key];
  if (custom) return applyTemplate(custom, vars);
  const fn = DEFAULT_PROMPTS[key];
  if (typeof fn === 'function') return fn(...Object.values(vars));
  return fn || '';
}

// ─── LOCAL GENERATORS ─────────────────────────────────────────────────────────
function genImageBlock(p) {
  return `<!-- wp:image {"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large">
  <img src="${esc(p.urlImage)}" alt="${esc(p.marque)} ${esc(p.nom)} - test et avis" loading="lazy"/>
  <figcaption>${esc(p.marque)} ${esc(p.nom)}</figcaption>
</figure>
<!-- /wp:image -->`;
}

function genCtaBlock(p) {
  const href = (p.urlAffilie||'').replace(/&/g,'&amp;');
  return `<!-- wp:columns {"verticalAlignment":"center","backgroundColor":"palette-color-5"} -->
<div class="wp-block-columns are-vertically-aligned-center has-palette-color-5-background-color has-background"><!-- wp:column {"verticalAlignment":"center"} --><div class="wp-block-column is-vertically-aligned-center"><!-- wp:paragraph {"align":"center"} --><p class="has-text-align-center"><strong>Achetez la ${esc(p.marque)} ${esc(p.nom)} au meilleur prix</strong></p><!-- /wp:paragraph --></div><!-- /wp:column --><!-- wp:column {"verticalAlignment":"center"} --><div class="wp-block-column is-vertically-aligned-center"><!-- wp:buttons {"align":"wide","layout":{"type":"flex","justifyContent":"center"}} --><div class="wp-block-buttons alignwide"><!-- wp:button {"textAlign":"center"} --><div class="wp-block-button"><a class="wp-block-button__link has-text-align-center wp-element-button" href="${href}" target="_blank" rel="nofollow noreferrer noopener">Voir les meilleures offres</a></div><!-- /wp:button --></div><!-- /wp:buttons --></div><!-- /wp:column --></div><!-- /wp:columns -->`;
}

// ─── PIPELINE ─────────────────────────────────────────────────────────────────
async function runCompSteps(compId) {
  const comp = db.comparatifs.find(c => c.id === compId);
  if (!comp) return;
  state.generating = true;
  state.stepStatus = Array(10).fill('pending');
  state.liveUsage = { inputTokens: 0, outputTokens: 0, cost: 0, apiCalls: 0 };
  if (!comp.usage) comp.usage = { inputTokens: 0, outputTokens: 0, cost: 0, apiCalls: 0 };
  comp.status = 'generating';
  saveDB(); render();

  const csv = produitsToCSV(comp.produits);
  const modeles = comp.produits.map(p => `${p.marque} ${p.nom}`).join(', ');
  const themCtx = db.customPrompts?.['ctx_' + comp.thematique] || THEMATIQUE_CONTEXT[comp.thematique] || '';
  const sys = callPrompt('sys', {}) + (themCtx ? '\n\n' + themCtx : '');

  function setStep(i, s) { state.stepStatus[i] = s; render(); }
  const skip = (bloc) => bloc?.html && bloc?.status !== 'pending' && bloc?.status !== 'error';

  try {
    // Étape 1 : Intro
    if (skip(comp.blocs.intro)) { setStep(0,'done'); }
    else {
      setStep(0, 'active');
      comp.blocs.intro.html = await callClaude(sys, callPrompt('p_intro', {titre: comp.titre, csv, nbProduits: comp.produits.length, nb: comp.produits.length}));
      comp.blocs.intro.status = 'generated';
      setStep(0, 'done'); saveDB();
    }

    // Étape 2 : Tableau
    if (skip(comp.blocs.tableau)) { setStep(1,'done'); }
    else {
      setStep(1, 'active');
      comp.blocs.tableau.html = await callClaude(sys, callPrompt('p_tableau', {csv, template_css: TEMPLATE_TABLEAU_CSS}));
      comp.blocs.tableau.status = 'generated';
      setStep(1, 'done'); saveDB();
    }

    // Étapes 3+4+5+6+7 : par produit
    const batchSize = 3;
    const produits = comp.produits;
    setStep(2, 'active'); setStep(3, 'active'); setStep(4, 'active'); setStep(5, 'active'); setStep(6, 'active');

    for (let i = 0; i < produits.length; i += batchSize) {
      const batch = produits.slice(i, i + batchSize);
      await Promise.all(batch.map(async p => {
        const csvP = produitToCSV(p);
        const articles = (comp.articlesInternes||[]).map(a => `${a.titre} : ${a.url}`).join('\n');
        if (!skip(comp.blocs.fiches[p.id])) {
          comp.blocs.fiches[p.id].html = await callClaude(sys, callPrompt('p_fiche', {nom: p.nom, marque: p.marque, csv_produit: csvP, template_css: ''}));
          comp.blocs.fiches[p.id].status = 'generated';
        }
        if (!skip(comp.blocs.images[p.id])) {
          comp.blocs.images[p.id].html = genImageBlock(p);
          comp.blocs.images[p.id].status = 'generated';
        }
        if (!skip(comp.blocs.paragraphes[p.id])) {
          comp.blocs.paragraphes[p.id].html = await callClaude(sys, callPrompt('p_paragraphe', {nom: p.nom, marque: p.marque, csv_produit: csvP}));
          comp.blocs.paragraphes[p.id].status = 'generated';
        }
        if (!skip(comp.blocs.cta[p.id])) {
          comp.blocs.cta[p.id].html = genCtaBlock(p);
          comp.blocs.cta[p.id].status = 'generated';
        }
        if (!skip(comp.blocs.maillage[p.id])) {
          comp.blocs.maillage[p.id].html = await callClaude(sys, callPrompt('p_maillage', {nom: p.nom, marque: p.marque, articles}), 'claude-haiku-4-5');
          comp.blocs.maillage[p.id].status = 'generated';
          const matches = comp.blocs.maillage[p.id].html.match(/\{\{[^}]+\}\}/g) || [];
          const phObj = {};
          matches.forEach(m => { phObj[m] = ''; });
          comp.blocs.maillage[p.id].placeholders = phObj;
        }
      }));
      saveDB(); render();
    }
    setStep(2,'done'); setStep(3,'done'); setStep(4,'done'); setStep(5,'done'); setStep(6,'done');

    // Étape 8 : Éducatif
    if (skip(comp.blocs.educatif)) { setStep(7,'done'); }
    else {
      setStep(7, 'active');
      comp.blocs.educatif.html = await callClaude(sys, callPrompt('p_educatif', {csv, modeles}));
      comp.blocs.educatif.status = 'generated';
      setStep(7, 'done'); saveDB();
    }

    // Étape 9 : Conclusion
    if (skip(comp.blocs.conclusion)) { setStep(8,'done'); }
    else {
      setStep(8, 'active');
      const csvSorted = produitsToCSV([...comp.produits].sort((a,b)=>b.note-a.note));
      comp.blocs.conclusion.html = await callClaude(sys, callPrompt('p_conclusion', {csv: csvSorted}));
      comp.blocs.conclusion.status = 'generated';
      setStep(8, 'done'); saveDB();
    }

    // Étape 10 : FAQ
    if (skip(comp.blocs.faq)) { setStep(9,'done'); }
    else {
      setStep(9, 'active');
      comp.blocs.faq.html = await callClaude(sys, callPrompt('p_faq', {titre: comp.titre, modeles, template_css: TEMPLATE_FAQ_CSS}));
      comp.blocs.faq.status = 'generated';
      setStep(9, 'done'); saveDB();
    }

    comp.status = 'review';
    state.generating = false;
    saveDB();
    state.page = 'comp-review';
    state.reviewTab = 0;
    showToast('Génération terminée ! Passez en révision.');
    render();
  } catch(e) {
    state.generating = false;
    comp.status = 'generating'; // garder 'generating' pour afficher le bouton Reprendre
    const errIdx = state.stepStatus.findIndex(s => s === 'active');
    if (errIdx >= 0) state.stepStatus[errIdx] = 'error';
    saveDB(); render();
    showToast('Erreur : ' + e.message, 'err');
  }
}

// ─── ASSEMBLE ────────────────────────────────────────────────────────────────
function assembleComparatif(comp) {
  let html = '';
  html += (comp.blocs.intro.html || '') + '\n';
  html += `<!-- wp:heading {"level":2} -->\n<h2 class="wp-block-heading">Top ${comp.produits.length} des meilleures chaussures de running</h2>\n<!-- /wp:heading -->\n`;
  html += (comp.blocs.tableau.html || '') + '\n';
  html += `<!-- wp:heading {"level":2} -->\n<h2 class="wp-block-heading">Fiches &amp; avis détaillés</h2>\n<!-- /wp:heading -->\n`;
  comp.produits.forEach(p => {
    const paraHtml = comp.blocs.paragraphes[p.id]?.html || '';
    // Ajouter un heading de secours si le paragraphe n'en contient pas
    if (paraHtml && !paraHtml.includes('wp:heading')) {
      html += `<!-- wp:heading {"level":2} -->\n<h2 class="wp-block-heading">${esc(p.marque)} ${esc(p.nom)}</h2>\n<!-- /wp:heading -->\n`;
    }
    html += paraHtml + '\n';
    html += (comp.blocs.images[p.id]?.html || '') + '\n';
    html += (comp.blocs.fiches[p.id]?.html || '') + '\n';
    html += (comp.blocs.maillage[p.id]?.html || '') + '\n';
    html += (comp.blocs.cta[p.id]?.html || '') + '\n';
  });
  html += (comp.blocs.educatif.html || '') + '\n';
  html += (comp.blocs.conclusion.html || '') + '\n';
  html += (comp.blocs.faq.html || '') + '\n';
  return html;
}

// ─── COHERENCE CHECK ─────────────────────────────────────────────────────────
function checkCompCoherence(comp) {
  const alerts = [];
  comp.produits.forEach(p => {
    const tableauHtml = comp.blocs.tableau.html || '';
    const ficheHtml = comp.blocs.fiches[p.id]?.html || '';
    if (!ficheHtml) { alerts.push({ type:'error', msg:`Fiche manquante pour ${p.marque} ${p.nom}` }); return; }
    if (!tableauHtml.includes(p.nom)) alerts.push({ type:'warning', msg:`${p.nom} : nom absent du tableau` });
    if (!ficheHtml.includes(String(p.prix))) alerts.push({ type:'warning', msg:`${p.nom} : prix ${p.prix}€ absent de la fiche` });
    if (!ficheHtml.includes(String(p.note))) alerts.push({ type:'warning', msg:`${p.nom} : note ${p.note} absente de la fiche` });
    const ctaHtml = comp.blocs.cta[p.id]?.html || '';
    if (p.urlAffilie && !ctaHtml.includes(p.urlAffilie.slice(0,30))) alerts.push({ type:'warning', msg:`${p.nom} : lien affilié absent du CTA` });
    const maillageHtml = comp.blocs.maillage[p.id]?.html || '';
    if (maillageHtml.includes('{{')) alerts.push({ type:'warning', msg:`${p.nom} : placeholders {{ }} non remplacés dans le maillage` });
  });
  // Check valid blocs
  const globalBlocs = ['intro','tableau','educatif','conclusion','faq'];
  globalBlocs.forEach(k => {
    if (!comp.blocs[k]?.html) alerts.push({ type:'error', msg:`Bloc global "${k}" manquant` });
  });
  if (alerts.length === 0) alerts.push({ type:'ok', msg:'Aucun problème détecté — article prêt à assembler !' });
  return alerts;
}

// ─── WORDPRESS PUSH ──────────────────────────────────────────────────────────
async function pushCompToWordPress(comp, siteName) {
  const creds = db.wpCreds?.[siteName];
  if (!creds?.user) { alert('Configure les accès WordPress pour ' + siteName + ' dans Paramètres.'); return; }
  const site = WP_SITES[siteName];
  if (!site) { alert('Site inconnu : ' + siteName); return; }
  const auth = 'Basic ' + btoa(creds.user + ':' + creds.password);
  const articleHtml = comp.articleAssemble || assembleComparatif(comp);
  try {
    const res = await fetch(`${site.url}/wp-json/wp/v2/${site.postType}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': auth },
      body: JSON.stringify({ title: comp.titre, content: articleHtml, status: 'draft' })
    });
    if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(`Erreur ${res.status}: ${e?.message||res.statusText}`); }
    comp.status = 'published';
    saveDB(); render();
    showToast('Brouillon créé sur ' + siteName + ' !');
  } catch(e) {
    showToast('Erreur WordPress : ' + e.message, 'err');
  }
}

// ─── EXPORT ───────────────────────────────────────────────────────────────────
function downloadFile(content, filename, type='text/html') {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], { type }));
  a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}

function downloadCSVTemplate() {
  const header = 'nom,marque,prix,note,poids,drop,mousse,usages,pointFort1,pointFort2,pointFaible,urlImage,urlAffilie,urlTest';
  const rows = [
    '"SuperBlast 2","Asics",220,4.6,246,8,"FFB Turbo","Footing|Endurance|Tempo","Polyvalence et confort","Légèreté record","Prix élevé","https://exemple.com/img1.jpg","https://fsx.i-run.fr/?P4572B581705191&redir=URL1","https://run-evasion.fr/test/asics-superblast-2/"',
    '"Clifton 9","Hoka",160,4.4,265,5,"CMEVA","Footing|Sorties longues|Récupération","Amorti généreux","Confort au quotidien","Dynamisme limité","https://exemple.com/img2.jpg","https://fsx.i-run.fr/?P4572B581705191&redir=URL2","https://run-evasion.fr/test/hoka-clifton-9/"',
    '"Kinvara 14","Saucony",130,4.2,215,4,"PWRRUN","Tempo|Compétition|Footing","Légèreté exceptionnelle","Réactivité","Amorti minimal","https://exemple.com/img3.jpg","https://fsx.i-run.fr/?P4572B581705191&redir=URL3",""',
  ];
  const csv = [header, ...rows].join('\n');
  downloadFile(csv, 'modele-comparatif.csv', 'text/csv;charset=utf-8;');
}

// ─── RENDER HELPERS ───────────────────────────────────────────────────────────
function statusIcon(s) {
  const map = { pending:'⚪', generating:'🔄', generated:'🔵', edited:'🟡', validated:'✅', error:'❌' };
  return map[s] || '⚪';
}
function statusBadge(s) {
  const map = {
    pending:'<span class="badge badge-gray">En attente</span>',
    generating:'<span class="badge badge-yellow">En cours…</span>',
    generated:'<span class="badge badge-blue">Généré</span>',
    edited:'<span class="badge badge-yellow">Modifié</span>',
    validated:'<span class="badge badge-green">Validé</span>',
    error:'<span class="badge badge-red">Erreur</span>'
  };
  return map[s] || `<span class="badge badge-gray">${s}</span>`;
}
const STATUS_BADGE_CLASS = {pending:'badge-gray',generating:'badge-yellow',generated:'badge-blue',edited:'badge-yellow',validated:'badge-green',error:'badge-red'};

// ─── RENDER SIDEBAR ───────────────────────────────────────────────────────────
function renderSidebar() {
  const p = state.page;
  return `
<div class="logo">⚖️ Comparatif</div>
<button class="nav-item ${p==='home'?'active':''}" data-page="home">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
  Accueil
</button>
<button class="nav-item ${p==='comp-new'?'active':''}" data-page="comp-new">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18"/></svg>
  Nouveau comparatif
</button>
<button class="nav-item ${p==='steps-prompts'?'active':''}" data-page="steps-prompts">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg>
  Étapes & Prompts
</button>
<div class="nav-sep"></div>
<div class="nav-section">Paramètres</div>
<button class="nav-item ${p==='settings'?'active':''}" data-page="settings">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
  Paramètres
</button>`;
}

// ─── RENDER HOME ──────────────────────────────────────────────────────────────
function renderHome() {
  const comps = db.comparatifs || [];
  const statusMap = { draft:'badge-gray', generating:'badge-yellow', review:'badge-blue', ready:'badge-green', published:'badge-green' };
  const statusLabel = { draft:'Brouillon', generating:'En cours…', review:'En révision', ready:'Prêt', published:'Publié' };
  return `
<div class="page-header">
  <h1>Mes comparatifs</h1>
  <p>${comps.length} comparatif${comps.length!==1?'s':''} créé${comps.length!==1?'s':''}</p>
</div>
<div class="page-content">
  ${comps.length===0 ? `
    <div class="empty-state">
      <div style="font-size:48px;margin-bottom:16px">⚖️</div>
      <h3>Aucun comparatif pour l'instant</h3>
      <p>Créez votre premier comparatif de chaussures de running !</p>
      <br>
      <button class="btn btn-primary" data-page="comp-new">+ Nouveau comparatif</button>
    </div>
  ` : `
    <div style="display:flex;justify-content:flex-end;margin-bottom:16px">
      <button class="btn btn-primary" data-page="comp-new">+ Nouveau comparatif</button>
    </div>
    <div class="comp-grid">
      ${comps.map(c => `
        <div class="comp-card" data-comp-id="${c.id}" data-action="open-comp">
          <div class="comp-card-title">${esc(c.titre)}</div>
          <div class="comp-card-meta">
            <span>${c.produits?.length||0} produits</span>
            <span>${c.date||''}</span>
            <span><span class="badge ${statusMap[c.status]||'badge-gray'}">${statusLabel[c.status]||c.status}</span></span>
            ${c.usage ? `<span style="font-weight:600">💰 ${formatCost(c.usage.cost)}</span>` : ''}
          </div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn btn-sm btn-secondary" data-comp-id="${c.id}" data-action="continue-comp">Continuer</button>
            <button class="btn btn-sm btn-danger" data-comp-id="${c.id}" data-action="delete-comp">Supprimer</button>
          </div>
        </div>
      `).join('')}
    </div>
  `}
</div>`;
}

// ─── RENDER SETTINGS ──────────────────────────────────────────────────────────
function renderSettings() {
  const wc = db.wpCreds || {};
  return `
<div class="page-header">
  <h1>Paramètres</h1>
  <p>Configurez votre clé API et les accès WordPress</p>
</div>
<div class="page-content">
  <div class="card">
    <div class="card-title">🤖 API Claude (Anthropic)</div>
    <div class="form-group">
      <label class="form-label">Clé API</label>
      <input type="password" class="form-input" id="s-apikey" value="${esc(db.apiKey||'')}" placeholder="sk-ant-api03-…">
    </div>
    <button class="btn btn-primary" id="s-save-api">Enregistrer la clé API</button>
  </div>
  <div class="card">
    <div class="card-title">🌐 WordPress — Run Evasion</div>
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Nom d'utilisateur</label>
        <input class="form-input" id="s-wp-re-user" value="${esc(wc['Run Evasion']?.user||'')}" placeholder="admin">
      </div>
      <div class="form-group">
        <label class="form-label">Mot de passe d'application</label>
        <input type="password" class="form-input" id="s-wp-re-pass" value="${esc(wc['Run Evasion']?.password||'')}" placeholder="xxxx xxxx xxxx xxxx">
      </div>
    </div>
    <button class="btn btn-primary" data-save-wp="Run Evasion">Enregistrer</button>
  </div>
</div>`;
}

// ─── RENDER COMP NEW ─────────────────────────────────────────────────────────
function renderCompNew() {
  const compId = state.compId;
  let comp = compId ? db.comparatifs.find(c => c.id === compId) : null;
  if (!comp) {
    comp = {
      id: Date.now(), titre:'', thematique:'general', status:'draft',
      date: new Date().toISOString().slice(0,10), targetSite:'Run Evasion',
      produits:[], blocs:null, articleAssemble:'', articlesInternes:[]
    };
    db.comparatifs.unshift(comp);
    state.compId = comp.id;
    saveDB();
  }
  const allComplete = comp.produits.length >= 2 && comp.produits.every(isProduitComplete);
  return `
<div class="page-header">
  <h1>Nouveau comparatif</h1>
  <p>Saisissez les informations du comparatif et les produits à comparer</p>
</div>
<div class="page-content">
  <div class="card">
    <div class="card-title">Informations générales</div>
    <div class="form-grid">
      <div class="form-group" style="grid-column:1/-1">
        <label class="form-label">Titre du comparatif</label>
        <input class="form-input" id="cn-titre" value="${esc(comp.titre)}" placeholder="Meilleures chaussures de running 2026">
      </div>
      <div class="form-group">
        <label class="form-label">Thématique</label>
        ${(() => {
          const usedThemas = db.comparatifs.filter(c => c.id !== comp.id && c.titre).map(c => c.thematique);
          return `<select class="form-input" id="cn-thematique">
          ${THEMATIQUES.map(t => {
            const done = usedThemas.includes(t);
            return `<option value="${t}" ${comp.thematique===t?'selected':''} ${done && comp.thematique!==t?'disabled':''}>${THEMATIQUE_LABELS[t]}${done?' ✓ (déjà fait)':''}</option>`;
          }).join('')}
        </select>`;
        })()}
        ${(() => {
          const usedThemas = db.comparatifs.filter(c => c.id !== comp.id && c.titre).map(c => c.thematique);
          const usedCount = [...new Set(usedThemas)].length;
          return usedCount > 0 ? `<p style="font-size:11px;color:var(--gray);margin-top:4px">💡 ${usedCount} thématique${usedCount>1?'s':''} déjà utilisée${usedCount>1?'s':''} (grisée${usedCount>1?'s':''})</p>` : '';
        })()}
      </div>
      <div class="form-group">
        <label class="form-label">Site cible</label>
        <select class="form-input" id="cn-site">
          <option value="Run Evasion" selected>Run Evasion</option>
        </select>
      </div>
    </div>
    <button class="btn btn-secondary" id="cn-save-info">Enregistrer</button>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="card-title" style="margin:0">Produits (${comp.produits.length})</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" id="cn-dl-csv">⬇ Modèle CSV</button>
        <label class="btn btn-secondary btn-sm" style="cursor:pointer">
          📂 Importer CSV
          <input type="file" accept=".csv" id="cn-csv-import" style="display:none">
        </label>
        <button class="btn btn-primary btn-sm" id="cn-add-product">+ Ajouter un produit</button>
      </div>
    </div>
    ${comp.produits.length === 0 ? `
      <div style="text-align:center;padding:32px;color:var(--gray);border:2px dashed var(--gray-border);border-radius:10px">
        <div style="font-size:32px;margin-bottom:8px">👟</div>
        <p>Ajoutez au moins 2 produits pour lancer la génération</p>
      </div>
    ` : `
      <div class="product-list" id="cn-product-list">
        ${comp.produits.map((p,i) => `
          <div class="product-item" draggable="true" data-pid="${p.id}">
            <span style="color:var(--gray);font-size:12px;cursor:grab">⠿</span>
            ${p.urlImage ? `<img src="${esc(p.urlImage)}" alt="">` : `<div style="width:48px;height:48px;background:var(--bg);border-radius:6px;border:1px solid var(--gray-border);display:flex;align-items:center;justify-content:center;font-size:20px">👟</div>`}
            <div class="product-item-info">
              <div class="product-item-name">${esc(p.marque)} ${esc(p.nom)}</div>
              <div class="product-item-meta">${p.prix}€ · Note : ${p.note}/5 · ${(p.usages||[]).join(', ')}</div>
            </div>
            <div style="margin-right:8px">${isProduitComplete(p) ? '<span class="badge badge-green">✓ Complet</span>' : '<span class="badge badge-yellow">Incomplet</span>'}</div>
            <div class="product-item-actions">
              <button class="btn btn-sm btn-ghost" data-edit-pid="${p.id}">✏️ Éditer</button>
              <button class="btn btn-sm btn-danger" data-del-pid="${p.id}">🗑</button>
            </div>
          </div>
        `).join('')}
      </div>
    `}
  </div>

  ${comp.produits.length >= 2 ? (() => {
    const n = comp.produits.length;
    // Appels API : intro + tableau + N*(fiche+paragraphe+maillage) + educatif + conclusion + faq
    const sonnetCalls = 2 + n * 2 + 3; // intro, tableau, N*fiche, N*para, educ, concl, faq
    const haikuCalls = n; // N * maillage
    const apiCalls = sonnetCalls + haikuCalls;
    // Estimation tokens Sonnet (intro, tableau, fiches, paragraphes, educatif, conclusion, faq)
    const sonnetIn = 500 + 3000 + n*(3000+1000) + 1500 + 1500 + 1500;
    const sonnetOut = 800 + 4000 + n*(4000+500) + 3000 + 1500 + 2000;
    // Estimation tokens Haiku (maillage)
    const haikuIn = n * 500;
    const haikuOut = n * 300;
    const costSonnet = calcCost(sonnetIn, sonnetOut, 'claude-sonnet-4-5');
    const costHaiku = calcCost(haikuIn, haikuOut, 'claude-haiku-4-5');
    const costTotal = costSonnet + costHaiku;
    const totalIn = sonnetIn + haikuIn;
    const totalOut = sonnetOut + haikuOut;
    const mins = Math.ceil(apiCalls * 0.35);
    return `<div class="card" style="margin-top:12px;border-left:3px solid var(--green)">
      <div class="card-title">💰 Estimation du coût de génération</div>
      <div class="stats-row" style="margin-bottom:12px">
        <div class="stat-card"><div class="val">${apiCalls}</div><div class="lbl">Appels API</div></div>
        <div class="stat-card"><div class="val">${(totalIn/1000).toFixed(0)}K</div><div class="lbl">Tokens entrée</div></div>
        <div class="stat-card"><div class="val">${(totalOut/1000).toFixed(0)}K</div><div class="lbl">Tokens sortie</div></div>
        <div class="stat-card"><div class="val" style="color:var(--green)">${formatCost(costTotal)}</div><div class="lbl">Coût estimé</div></div>
        <div class="stat-card"><div class="val">~${mins} min</div><div class="lbl">Durée estimée</div></div>
      </div>
      <div style="font-size:12px;color:var(--gray);display:flex;flex-wrap:wrap;gap:12px">
        <span>Sonnet : ${sonnetCalls} appels · ${formatCost(costSonnet)}</span>
        <span>Haiku : ${haikuCalls} appels · ${formatCost(costHaiku)}</span>
        <span>Images + CTA : ${n*2} blocs (gratuits, générés localement)</span>
      </div>
    </div>`;
  })() : ''}
  <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px">
    <button class="btn btn-secondary" data-page="home">Annuler</button>
    <button class="btn btn-primary ${!allComplete?'disabled':''}" id="cn-launch" ${!allComplete?'disabled':''} title="${!allComplete?'Ajoutez au moins 2 produits complets':''}">
      Lancer la génération →
    </button>
  </div>
  ${!allComplete && comp.produits.length > 0 ? `<p style="text-align:right;color:var(--gray);font-size:12px;margin-top:6px">⚠️ Tous les produits doivent être complets (${comp.produits.filter(isProduitComplete).length}/${comp.produits.length} complets)</p>` : ''}
</div>`;
}

// ─── PRODUCT MODAL ────────────────────────────────────────────────────────────
function renderProductModal(pid) {
  const comp = getComp();
  const p = pid ? comp.produits.find(x => String(x.id) === String(pid)) : null;
  const isNew = !p;
  const v = p || { id:uid(), nom:'', marque:'', prix:'', note:'', poids:'', drop:'', mousse:'', usages:[], pointFort1:'', pointFort2:'', pointFaible:'', urlImage:'', urlAffilie:'', urlTest:'' };
  return `
<div class="modal-overlay" id="product-modal">
  <div class="modal">
    <div class="modal-header">
      <h2>${isNew ? 'Ajouter un produit' : 'Éditer le produit'}</h2>
      <button class="modal-close" id="close-product-modal">✕</button>
    </div>
    <input type="hidden" id="pm-pid" value="${v.id}">
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Nom du modèle *</label>
        <input class="form-input" id="pm-nom" value="${esc(v.nom)}" placeholder="SuperBlast 2">
      </div>
      <div class="form-group">
        <label class="form-label">Marque *</label>
        <select class="form-input" id="pm-marque">
          <option value="">-- Choisir --</option>
          ${MARQUES.map(m => `<option value="${m}" ${v.marque===m?'selected':''}>${m}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Prix (€) *</label>
        <input type="number" class="form-input" id="pm-prix" value="${v.prix}" min="0" step="1">
      </div>
      <div class="form-group">
        <label class="form-label">Note /5 *</label>
        <input type="number" class="form-input" id="pm-note" value="${v.note}" min="0" max="5" step="0.1">
      </div>
      <div class="form-group">
        <label class="form-label">Poids (g) *</label>
        <input type="number" class="form-input" id="pm-poids" value="${v.poids}" min="0">
      </div>
      <div class="form-group">
        <label class="form-label">Drop (mm) *</label>
        <input type="number" class="form-input" id="pm-drop" value="${v.drop}" min="0" max="30">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Mousse / Technologie *</label>
      <input class="form-input" id="pm-mousse" value="${esc(v.mousse)}" placeholder="FFB Turbo">
    </div>
    <div class="form-group">
      <label class="form-label">Usages * (sélectionner au moins 1)</label>
      <div class="checkbox-grid">
        ${USAGES_LIST.map(u => `
          <label class="checkbox-item">
            <input type="checkbox" name="pm-usage" value="${u}" ${(v.usages||[]).includes(u)?'checked':''}> ${u}
          </label>
        `).join('')}
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Point fort 1 *</label>
      <input class="form-input" id="pm-pf1" value="${esc(v.pointFort1)}" placeholder="Polyvalence et confort">
    </div>
    <div class="form-group">
      <label class="form-label">Point fort 2 *</label>
      <input class="form-input" id="pm-pf2" value="${esc(v.pointFort2)}" placeholder="Légèreté record">
    </div>
    <div class="form-group">
      <label class="form-label">Point faible *</label>
      <input class="form-input" id="pm-pfail" value="${esc(v.pointFaible)}" placeholder="Prix élevé">
    </div>
    <div class="form-group">
      <label class="form-label">URL image *</label>
      <input type="url" class="form-input" id="pm-img" value="${esc(v.urlImage)}" placeholder="https://…">
    </div>
    <div class="form-group">
      <label class="form-label">URL affilié i-Run *</label>
      <input type="url" class="form-input" id="pm-aff" value="${esc(v.urlAffilie)}" placeholder="https://fsx.i-run.fr/…">
    </div>
    <div class="form-group">
      <label class="form-label">URL test run-evasion.fr (optionnel)</label>
      <input type="url" class="form-input" id="pm-test" value="${esc(v.urlTest)}" placeholder="https://run-evasion.fr/test/…">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="close-product-modal-2">Annuler</button>
      <button class="btn btn-primary" id="pm-save" data-is-new="${isNew}">Enregistrer</button>
    </div>
  </div>
</div>`;
}

// ─── RENDER COMP PROGRESS ─────────────────────────────────────────────────────
function renderCompProgress() {
  const comp = getComp();
  if (!comp) return '<div class="page-content"><p>Comparatif introuvable.</p></div>';
  const doneCount = state.stepStatus.filter(s=>s==='done').length;
  const pct = Math.round(doneCount/10*100);
  return `
<div class="page-header">
  <h1>Génération en cours</h1>
  <p>${esc(comp.titre)} — ${comp.produits.length} produits</p>
</div>
<div class="page-content">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <span style="font-weight:700">${doneCount}/10 étapes</span>
      <span style="color:var(--gray)">${pct}%</span>
    </div>
    <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
    <div class="step-list">
      ${STEP_LABELS.map((label,i) => {
        const s = state.stepStatus[i];
        return `
        <div class="step-row ${s==='active'?'active':''} ${s==='done'?'done':''}">
          <div class="step-dot ${s}">
            ${s==='done'?'✓': s==='error'?'✕': s==='active'?'…': (i+1)}
          </div>
          <span>${label}</span>
          <span style="margin-left:auto">${statusBadge(s==='active'?'generating': s==='done'?'validated': s==='error'?'error': 'pending')}</span>
        </div>`;
      }).join('')}
    </div>
  </div>
  <div class="card" style="margin-top:16px">
    <div class="card-title">💰 Coût en temps réel</div>
    <div class="stats-row">
      <div class="stat-card"><div class="val">${state.liveUsage.apiCalls}</div><div class="lbl">Appels API</div></div>
      <div class="stat-card"><div class="val">${(state.liveUsage.inputTokens/1000).toFixed(1)}K</div><div class="lbl">Tokens entrée</div></div>
      <div class="stat-card"><div class="val">${(state.liveUsage.outputTokens/1000).toFixed(1)}K</div><div class="lbl">Tokens sortie</div></div>
      <div class="stat-card"><div class="val" style="color:${state.liveUsage.cost > 1 ? 'var(--yellow)' : 'var(--green)'}">${formatCost(state.liveUsage.cost)}</div><div class="lbl">Coût total</div></div>
    </div>
  </div>
  ${state.generating ? `<div class="alert alert-info" style="margin-top:16px">⏳ Génération en cours, ne fermez pas cette fenêtre…</div>` : ''}
  ${!state.generating && state.stepStatus.includes('error') ? `
    <div class="alert alert-warn" style="margin-top:16px">
      ❌ La génération s'est interrompue. Les blocs déjà générés sont sauvegardés.
      <br><br>
      <button class="btn btn-primary" id="btn-reprendre">🔄 Reprendre la génération</button>
    </div>
  ` : ''}
  ${!state.generating && !state.stepStatus.includes('error') && doneCount === 10 ? `
    <div class="alert" style="margin-top:16px;background:rgba(3,202,161,.1);border:1px solid rgba(3,202,161,.3);color:#035e4d">
      ✅ Génération terminée ! Coût final : <strong>${formatCost(state.liveUsage.cost)}</strong>
      <button class="btn btn-primary btn-sm" style="margin-left:12px" data-page="comp-review">Aller en révision →</button>
    </div>
  ` : ''}
</div>`;
}

// ─── RENDER COMP REVIEW ───────────────────────────────────────────────────────
function renderCompReview() {
  const comp = getComp();
  if (!comp) return '<div class="page-content"><p>Comparatif introuvable.</p></div>';
  const tab = state.reviewTab;
  return `
<div class="page-header">
  <h1>Révision — ${esc(comp.titre)}</h1>
  <p>Relisez et validez chaque bloc avant l'assemblage</p>
</div>
<div class="page-content">
  <div class="tabs">
    <button class="tab-btn ${tab===0?'active':''}" data-review-tab="0">📋 Vue d'ensemble</button>
    <button class="tab-btn ${tab===1?'active':''}" data-review-tab="1">✏️ Éditeur de bloc</button>
    <button class="tab-btn ${tab===2?'active':''}" data-review-tab="2">🔗 Maillage interne</button>
  </div>
  ${tab===0 ? renderReviewOverview(comp) : ''}
  ${tab===1 ? renderReviewEditor(comp) : ''}
  ${tab===2 ? renderReviewMaillage(comp) : ''}
</div>`;
}

function renderReviewOverview(comp) {
  const globalBlocs = [
    {key:'intro',label:'Introduction + Méthodologie'},
    {key:'tableau',label:'Tableau triable'},
    {key:'educatif',label:'Sections éducatives'},
    {key:'conclusion',label:'Conclusion + Top 3'},
    {key:'faq',label:'FAQ HTML'},
  ];
  let totalBlocs = globalBlocs.length + comp.produits.length * 5;
  let validatedCount = 0;
  globalBlocs.forEach(({key}) => { if(comp.blocs[key]?.status==='validated') validatedCount++; });
  comp.produits.forEach(p => {
    ['fiches','images','paragraphes','cta','maillage'].forEach(t => {
      if(comp.blocs[t]?.[p.id]?.status==='validated') validatedCount++;
    });
  });

  const allGlobalValidated = globalBlocs.every(({key}) => comp.blocs[key]?.status==='validated');
  const allProdValidated = comp.produits.every(p => ['fiches','paragraphes','cta'].every(t => comp.blocs[t]?.[p.id]?.status==='validated'));
  const canAssemble = allGlobalValidated && allProdValidated;

  return `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div>
      <span class="badge badge-green">${validatedCount}/${totalBlocs} validés</span>
    </div>
    <button class="btn btn-primary ${!canAssemble?'disabled':''}" id="go-assemble" ${!canAssemble?'disabled':''}>
      Assembler l'article →
    </button>
  </div>
  ${!canAssemble ? `<div class="alert alert-warn">Validez tous les blocs obligatoires (intro, tableau, fiches, paragraphes, CTA, éducatif, conclusion, FAQ) avant d'assembler.</div>` : ''}

  <div class="card">
    <div class="card-title">Blocs globaux</div>
    <table class="blocs-table">
      <thead><tr><th>Bloc</th><th>Statut</th><th>Actions</th></tr></thead>
      <tbody>
        ${globalBlocs.map(({key,label}) => {
          const bloc = comp.blocs[key];
          return `<tr>
            <td><strong>${label}</strong></td>
            <td>${statusBadge(bloc?.status||'pending')}</td>
            <td style="display:flex;gap:6px">
              ${bloc?.html ? `<button class="btn btn-sm btn-ghost" data-view-bloc="${key}">👁 Voir</button>` : ''}
              <button class="btn btn-sm btn-secondary" data-regen-bloc="${key}">🔄 Régénérer</button>
              ${bloc?.status!=='validated' && bloc?.html ? `<button class="btn btn-sm btn-primary" data-validate-bloc="${key}">✅ Valider</button>` : ''}
              ${bloc?.status==='validated' ? `<span class="badge badge-green">✅ Validé</span>` : ''}
            </td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="card-title">Blocs par produit</div>
    <div style="overflow-x:auto">
    <table class="blocs-table">
      <thead>
        <tr>
          <th>Produit</th>
          <th>Paragraphe</th>
          <th>Image</th>
          <th>Fiche</th>
          <th>Maillage</th>
          <th>CTA</th>
        </tr>
      </thead>
      <tbody>
        ${comp.produits.map(p => {
          const keys = ['paragraphes','images','fiches','maillage','cta'];
          const labels = ['paragraphes','images','fiches','maillage','cta'];
          return `<tr>
            <td><strong>${esc(p.marque)}<br><span style="font-weight:400;font-size:12px">${esc(p.nom)}</span></strong></td>
            ${keys.map(k => {
              const bloc = comp.blocs[k]?.[p.id];
              const bkey = `${k}:${p.id}`;
              return `<td>
                <div class="bloc-cell">
                  <button class="bloc-dot-btn ${bloc?.html?'':'disabled'}" data-view-bloc="${bkey}" ${!bloc?.html?'disabled':''}>
                    ${statusIcon(bloc?.status||'pending')} ${bloc?.status==='validated'?'✓':'👁'}
                  </button>
                  ${bloc?.status!=='validated' && bloc?.html ? `<button class="btn btn-sm btn-primary" style="font-size:11px;padding:3px 6px" data-validate-bloc="${bkey}">✅</button>` : ''}
                </div>
              </td>`;
            }).join('')}
          </tr>`;
        }).join('')}
      </tbody>
    </table>
    </div>
  </div>`;
}

function renderReviewEditor(comp) {
  const key = state.currentBlockKey;
  if (!key) {
    return `<div style="text-align:center;padding:48px;color:var(--gray)">
      <p>Cliquez sur <strong>👁 Voir</strong> dans la vue d'ensemble pour ouvrir un bloc ici.</p>
    </div>`;
  }
  let bloc;
  if (key.includes(':')) {
    const [type, pid] = key.split(':');
    bloc = comp.blocs[type]?.[parseInt(pid)];
  } else {
    bloc = comp.blocs[key];
  }
  const html = bloc?.html || '';
  const iframeContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{margin:16px;font-family:system-ui,sans-serif;font-size:14px}*{max-width:100%}</style></head><body>${html}</body></html>`;
  return `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div style="font-weight:700">Édition : <code style="background:var(--bg);padding:2px 6px;border-radius:4px">${key}</code></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-secondary btn-sm" data-review-tab="0">◀ Retour</button>
      <button class="btn btn-secondary btn-sm" id="refresh-preview">🔄 Actualiser</button>
      <button class="btn btn-secondary btn-sm" data-regen-bloc="${key}">♻️ Régénérer</button>
      <button class="btn btn-primary btn-sm" data-validate-bloc="${key}">✅ Valider</button>
    </div>
  </div>
  <div class="split-view">
    <div class="split-pane">
      <label>Prévisualisation</label>
      <iframe id="bloc-preview" srcdoc="${esc(iframeContent)}" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>
    <div class="split-pane">
      <label>Code HTML</label>
      <textarea class="form-input" id="bloc-editor" style="flex:1;font-size:12px;font-family:monospace">${esc(html)}</textarea>
    </div>
  </div>
  <div style="margin-top:8px;color:var(--gray);font-size:12px">
    ${wordCount(html)} mots — ${(html||'').length} caractères — Statut : ${statusBadge(bloc?.status||'pending')}
  </div>`;
}

function renderReviewMaillage(comp) {
  return `
  <div class="card">
    <div class="card-title">🔗 Maillage interne — Remplacement des placeholders</div>
    <div class="form-group">
      <label class="form-label">Articles internes disponibles (un par ligne : URL | Titre)</label>
      <textarea class="form-input" id="articles-internes" rows="4" placeholder="https://run-evasion.fr/test/asics-gt2000/ | Test Asics GT-2000&#10;https://run-evasion.fr/test/hoka-clifton/ | Test Hoka Clifton">${(comp.articlesInternes||[]).map(a => `${a.url} | ${a.titre}`).join('\n')}</textarea>
      <button class="btn btn-sm btn-secondary" id="save-articles-internes" style="margin-top:6px">Enregistrer</button>
    </div>
  </div>
  ${comp.produits.map(p => {
    const bloc = comp.blocs.maillage?.[p.id];
    if (!bloc?.html) return '';
    const phs = bloc.placeholders || {};
    const phKeys = Object.keys(phs);
    if (phKeys.length === 0) return `
      <div class="card" style="margin-top:12px">
        <div class="card-title">${esc(p.marque)} ${esc(p.nom)} — <span class="badge badge-green">Aucun placeholder</span></div>
      </div>`;
    return `
    <div class="card" style="margin-top:12px">
      <div class="card-title">${esc(p.marque)} ${esc(p.nom)} — ${phKeys.length} placeholder${phKeys.length>1?'s':''}</div>
      <div class="placeholder-list">
        ${phKeys.map(ph => `
          <div class="placeholder-row">
            <span class="ph-key">${esc(ph)}</span>
            <input class="form-input" data-ph="${esc(ph)}" data-pid="${p.id}" value="${esc(phs[ph]||'')}" placeholder="URL de remplacement…">
            <span style="font-size:16px">${phs[ph] ? '🟢' : '🟡'}</span>
          </div>
        `).join('')}
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-primary btn-sm" data-apply-maillage="${p.id}">Appliquer</button>
        <button class="btn btn-secondary btn-sm" data-clean-maillage="${p.id}">Supprimer liens vides</button>
      </div>
    </div>`;
  }).join('')}`;
}

// ─── RENDER COMP ASSEMBLE ────────────────────────────────────────────────────
function renderCompAssemble() {
  const comp = getComp();
  if (!comp) return '<div class="page-content"><p>Comparatif introuvable.</p></div>';

  const alerts = checkCompCoherence(comp);
  const articleHtml = assembleComparatif(comp);
  comp.articleAssemble = articleHtml;
  saveDB();

  const wc = wordCount(articleHtml);
  const linkCount = (articleHtml.match(/<a /gi)||[]).length;
  const iframeContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{margin:24px;font-family:system-ui,sans-serif;font-size:15px;line-height:1.6;max-width:900px;margin:auto}*{max-width:100%;box-sizing:border-box}</style></head><body>${articleHtml}</body></html>`;

  return `
<div class="page-header">
  <h1>Assemblage — ${esc(comp.titre)}</h1>
  <p>Vérifiez la cohérence, prévisualisez et exportez</p>
</div>
<div class="page-content">
  <div class="stats-row" style="margin-bottom:16px">
    <div class="stat-card"><div class="val">${wc}</div><div class="lbl">Mots</div></div>
    <div class="stat-card"><div class="val">${comp.produits.length}</div><div class="lbl">Produits</div></div>
    <div class="stat-card"><div class="val">${linkCount}</div><div class="lbl">Liens</div></div>
    <div class="stat-card"><div class="val">${Math.round(articleHtml.length/1024)}Ko</div><div class="lbl">Taille HTML</div></div>
    ${comp.usage ? `
    <div class="stat-card"><div class="val">${comp.usage.apiCalls}</div><div class="lbl">Appels API</div></div>
    <div class="stat-card"><div class="val">${formatCost(comp.usage.cost)}</div><div class="lbl">Coût génération</div></div>
    ` : ''}
  </div>
  ${comp.usage ? `
  <div class="card" style="margin-bottom:16px">
    <div class="card-title">💰 Détails du coût de génération</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
      <div>Appels API : <strong>${comp.usage.apiCalls}</strong></div>
      <div>Tokens entrée : <strong>${(comp.usage.inputTokens/1000).toFixed(1)}K</strong></div>
      <div>Tokens sortie : <strong>${(comp.usage.outputTokens/1000).toFixed(1)}K</strong></div>
      <div>Coût total : <strong style="color:var(--green)">${formatCost(comp.usage.cost)}</strong></div>
    </div>
  </div>
  ` : ''}

  <div class="card">
    <div class="card-title">🔍 Vérifications automatiques</div>
    <div class="check-list">
      ${alerts.map(a => `
        <div class="check-item ${a.type==='ok'?'ok': a.type==='warning'?'warn': 'err'}">
          <span>${a.type==='ok'?'✅': a.type==='warning'?'⚠️': '❌'}</span>
          <span>${esc(a.msg)}</span>
        </div>
      `).join('')}
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="card-title" style="margin:0">👁 Prévisualisation</div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-sm btn-secondary" id="preview-desktop">🖥 Desktop</button>
        <button class="btn btn-sm btn-secondary" id="preview-mobile">📱 Mobile</button>
      </div>
    </div>
    <iframe id="full-preview" srcdoc="${esc(iframeContent)}" style="width:100%;min-height:600px;border:1px solid var(--gray-border);border-radius:8px" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="card-title">📤 Export</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn btn-primary" id="copy-wp">📋 Copier code WP</button>
      <button class="btn btn-secondary" id="push-re">🚀 Push WordPress</button>
      <button class="btn btn-secondary" id="export-html">⬇ Export HTML</button>
      <button class="btn btn-secondary" id="export-json">⬇ Export JSON</button>
    </div>
  </div>

  <div style="margin-top:16px">
    <button class="btn btn-ghost" data-review-back>◀ Retour à la révision</button>
  </div>
</div>`;
}

// ─── RENDER COMP VIEW ────────────────────────────────────────────────────────
function renderCompView() {
  const comp = getComp();
  if (!comp) return '<div class="page-content"><p>Comparatif introuvable.</p></div>';
  const statusMap = { draft:'badge-gray', generating:'badge-yellow', review:'badge-blue', ready:'badge-green', published:'badge-green' };
  const statusLabel = { draft:'Brouillon', generating:'En cours…', review:'En révision', ready:'Prêt', published:'Publié' };
  return `
<div class="page-header">
  <h1>${esc(comp.titre)}</h1>
  <p>Créé le ${comp.date} — ${comp.produits.length} produits — <span class="badge ${statusMap[comp.status]||'badge-gray'}">${statusLabel[comp.status]||comp.status}</span></p>
</div>
<div class="page-content">
  <div style="display:flex;gap:8px;margin-bottom:16px">
    <button class="btn btn-primary" data-action="go-review">✏️ Réviser</button>
    <button class="btn btn-secondary" data-action="go-assemble">📦 Assembler</button>
    <button class="btn btn-ghost" data-page="home">◀ Retour</button>
  </div>
  <div class="card">
    <div class="card-title">Produits (${comp.produits.length})</div>
    <div class="product-list">
      ${comp.produits.map(p => `
        <div class="product-item" style="cursor:default">
          ${p.urlImage ? `<img src="${esc(p.urlImage)}" alt="">` : `<div style="width:48px;height:48px;background:var(--bg);border-radius:6px;border:1px solid var(--gray-border);display:flex;align-items:center;justify-content:center">👟</div>`}
          <div class="product-item-info">
            <div class="product-item-name">${esc(p.marque)} ${esc(p.nom)}</div>
            <div class="product-item-meta">${p.prix}€ · Note : ${p.note}/5 · ${(p.usages||[]).slice(0,3).join(', ')}</div>
          </div>
        </div>
      `).join('')}
    </div>
  </div>
</div>`;
}

// ─── TOAST ────────────────────────────────────────────────────────────────────
function renderToast() {
  if (!state.toast) return '';
  const color = state.toast.type === 'err' ? '#fee2e2' : 'rgba(3,202,161,.15)';
  const border = state.toast.type === 'err' ? '#fca5a5' : 'rgba(3,202,161,.3)';
  const textColor = state.toast.type === 'err' ? '#991b1b' : '#035e4d';
  return `<div style="position:fixed;bottom:24px;right:24px;z-index:999;background:${color};border:1px solid ${border};color:${textColor};padding:12px 20px;border-radius:10px;font-weight:600;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,.15);max-width:320px">${esc(state.toast.msg)}</div>`;
}

// ─── RENDER STEPS & PROMPTS ──────────────────────────────────────────────────
function renderStepsPrompts() {
  const STEPS_META = [
    {
      num:1, label:'Introduction + Méthodologie', model:'Claude Sonnet', badge:'badge-blue', local:false,
      promptKey:'p_intro', vars:['${titre}','${csv}','${nbProduits}'],
      desc:'Génère l\'accroche du comparatif, la section "Comment nous avons sélectionné ces modèles" et le résumé rapide par profil.',
      output:'Blocs wp:paragraph + wp:heading (intro, méthodologie, résumé)'
    },
    {
      num:2, label:'Tableau HTML triable', model:'Claude Sonnet', badge:'badge-blue', local:false,
      promptKey:'p_tableau', vars:['${csv}','${template_css}'],
      desc:'Génère le tableau comparatif interactif avec tri par colonne (note, prix, modèle). Le CSS et le script JS sont inclus dans le bloc.',
      output:'Bloc wp:html — table.cc-table avec CSS embarqué + script de tri JS'
    },
    {
      num:3, label:'Fiches produit (×N)', model:'Claude Sonnet', badge:'badge-blue', local:false,
      promptKey:'p_fiche', vars:['${nom}','${marque}','${csv_produit}','${template_css}'],
      desc:'Génère une fiche produit complète pour chaque modèle : image, zone partenaire, specs, note étoiles, chips usage, pros/cons, CTA test, JSON-LD Product. Appelé 1 fois par produit, en parallèle par lots de 3.',
      output:'Bloc wp:html — article.product-block + JSON-LD schema.org'
    },
    {
      num:4, label:'Blocs image', model:'⚡ Local — sans API', badge:'badge-green', local:true,
      promptKey:null, vars:['p.urlImage','p.marque','p.nom'],
      desc:'Génère le bloc image WordPress standard. Aucun appel API, traitement instantané.',
      output:'Bloc wp:image avec src, alt et figcaption'
    },
    {
      num:5, label:'Paragraphes descriptifs (×N)', model:'Claude Sonnet', badge:'badge-blue', local:false,
      promptKey:'p_paragraphe', vars:['${nom}','${marque}','${csv_produit}'],
      desc:'Rédige un paragraphe de 150-200 mots avec heading pour chaque modèle. Sous-titre accrocheur + description des points forts + verdict usage. Appelé 1 fois par produit.',
      output:'Blocs wp:heading (h2) + wp:paragraph'
    },
    {
      num:6, label:'Blocs CTA', model:'⚡ Local — sans API', badge:'badge-green', local:true,
      promptKey:null, vars:['p.marque','p.nom','p.urlAffilie'],
      desc:'Génère le bloc CTA "Achetez au meilleur prix" avec le lien affilié i-Run. Template fixe, aucun appel API.',
      output:'Bloc wp:columns fond coloré + wp:button lien affilié'
    },
    {
      num:7, label:'Maillage interne (×N)', model:'Claude Haiku', badge:'badge-yellow', local:false,
      promptKey:'p_maillage', vars:['${nom}','${marque}','${articles}'],
      desc:'Génère 2-3 liens internes naturels vers des articles connexes. Si les URLs ne sont pas fournies, utilise des placeholders {{DOUBLE_ACCOLADES}} à remplacer dans l\'onglet Révision > Maillage. Haiku pour économiser les tokens.',
      output:'Bloc wp:paragraph avec <a> internes ou {{PLACEHOLDERS}}'
    },
    {
      num:8, label:'Sections éducatives', model:'Claude Sonnet', badge:'badge-blue', local:false,
      promptKey:'p_educatif', vars:['${csv}','${modeles}'],
      desc:'Rédige 3 sections SEO transversales : "Comment choisir ses chaussures", "Tableau des profils", "Critères techniques" (drop, mousse, poids).',
      output:'Blocs wp:heading (h2) + wp:paragraph'
    },
    {
      num:9, label:'Conclusion + Top 3', model:'Claude Sonnet', badge:'badge-blue', local:false,
      promptKey:'p_conclusion', vars:['${csv}'],
      desc:'Rédige la conclusion générale et le podium des 3 meilleurs modèles (triés par note décroissante). Inclut un appel à l\'action final.',
      output:'Blocs wp:heading + wp:paragraph — verdict final + podium'
    },
    {
      num:10, label:'FAQ HTML interactive', model:'Claude Sonnet', badge:'badge-blue', local:false,
      promptKey:'p_faq', vars:['${titre}','${modeles}','${template_css}'],
      desc:'Génère 6 questions/réponses SEO en HTML avec <details>/<summary>, CSS embarqué (.re-faq) et titres <h3> pour le référencement. Utilise le template FAQ.',
      output:'Bloc wp:html — section.re-faq avec 6 details'
    },
  ];

  const getPromptSource = (key) => {
    if (!key) return null;
    const fn = DEFAULT_PROMPTS[key];
    if (!fn) return null;
    if (typeof fn === 'string') return fn;
    // Get arrow function body from .toString()
    const src = fn.toString();
    // Extract the template literal content
    const tplMatch = src.match(/`([\s\S]+)`\s*$/);
    return tplMatch ? tplMatch[1] : src;
  };

  return `
<div class="page-header">
  <h1>Étapes & Prompts</h1>
  <p>Les 10 étapes du pipeline de génération — prompts envoyés à Claude à chaque étape</p>
</div>
<div class="page-content">

  <div class="card" style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="card-title" style="margin:0">🤖 Prompt système (system prompt)</div>
      <span class="badge badge-gray">Envoyé à chaque appel API</span>
    </div>
    <p style="color:var(--gray);font-size:12px;margin-bottom:8px">Ce prompt définit le rôle de Claude, le ton et les règles de formatage WordPress.</p>
    <textarea class="form-input" id="sp-sys" style="font-size:12px;font-family:monospace;min-height:80px">${esc(db.customPrompts?.['sys'] || SYS_COMP)}</textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn btn-primary btn-sm" data-save-prompt="sys">💾 Enregistrer</button>
      ${db.customPrompts?.['sys'] ? `<button class="btn btn-ghost btn-sm" data-reset-prompt="sys">↩ Réinitialiser</button><span class="badge badge-yellow" style="align-self:center">Personnalisé</span>` : '<span class="badge badge-gray" style="align-self:center">Par défaut</span>'}
    </div>
  </div>

  ${STEPS_META.map(step => {
    const hasPrompt = !!step.promptKey;
    const defaultTxt = hasPrompt ? getPromptDefaultText(step.promptKey) : '';
    const customTxt = hasPrompt ? (db.customPrompts?.[step.promptKey] || '') : '';
    const isCustom = !!customTxt;
    return `
  <div class="card" style="margin-bottom:14px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
      <div style="width:32px;height:32px;border-radius:50%;background:var(--green);color:#083b33;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;flex-shrink:0">${step.num}</div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:15px">${step.label}</div>
        <div style="font-size:12px;color:var(--gray);margin-top:2px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <span class="badge ${step.badge}">${step.model}</span>
          ${step.vars.map(v => `<code style="background:var(--bg);border:1px solid var(--gray-border);border-radius:4px;padding:1px 5px;font-size:11px">${esc(v)}</code>`).join(' ')}
          ${isCustom ? '<span class="badge badge-yellow">Personnalisé</span>' : ''}
        </div>
      </div>
    </div>
    <p style="font-size:13px;color:var(--dark);margin-bottom:8px">${step.desc}</p>
    <div style="font-size:12px;color:var(--gray);margin-bottom:10px"><strong>Sortie :</strong> ${esc(step.output)}</div>
    ${hasPrompt ? `
    <details style="margin-top:4px" ${isCustom ? '' : ''}>
      <summary style="cursor:pointer;font-size:12px;font-weight:700;color:var(--green);padding:6px 0;user-select:none">✏️ Modifier le prompt</summary>
      <div style="margin-top:10px">
        <p style="font-size:11px;color:var(--gray);margin-bottom:6px">Variables disponibles : ${step.vars.map(v=>`<code style="background:var(--bg);border:1px solid var(--gray-border);border-radius:3px;padding:1px 4px">${esc(v)}</code>`).join(' ')}</p>
        <textarea class="form-input" id="sp-${step.promptKey}" style="font-size:12px;font-family:monospace;min-height:180px" placeholder="Laissez vide pour utiliser le prompt par défaut…">${esc(customTxt)}</textarea>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" data-save-prompt="${step.promptKey}">💾 Enregistrer</button>
          <button class="btn btn-ghost btn-sm" data-copy-default="${step.promptKey}">📋 Copier le prompt par défaut</button>
          ${isCustom ? `<button class="btn btn-danger btn-sm" data-reset-prompt="${step.promptKey}">↩ Réinitialiser</button>` : ''}
        </div>
      </div>
    </details>
    ` : `<div style="font-size:12px;color:var(--gray);padding:8px 12px;background:rgba(3,202,161,.07);border-radius:6px;border-left:3px solid var(--green)">⚡ Génération locale — aucun prompt envoyé à Claude</div>`}
  </div>`;
  }).join('')}

  <div style="margin-top:32px;border-top:2px solid var(--gray-border);padding-top:24px">
    <h2 style="font-size:18px;font-weight:800;margin-bottom:8px">🎯 Contextes thématiques</h2>
    <p style="color:var(--gray);font-size:13px;margin-bottom:20px">Chaque thématique injecte un contexte spécifique dans le system prompt. Ce contexte oriente Claude pour adapter le ton, les critères et la structure de l'article.</p>

    ${THEMATIQUES.map(t => {
      const ctx = THEMATIQUE_CONTEXT[t] || '';
      const customKey = 'ctx_' + t;
      const customCtx = db.customPrompts?.[customKey] || '';
      const isCustom = !!customCtx;
      const displayCtx = customCtx || ctx;
      return `
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <span class="badge ${ctx ? 'badge-green' : 'badge-gray'}">${THEMATIQUE_LABELS[t]}</span>
        ${isCustom ? '<span class="badge badge-yellow">Personnalisé</span>' : ''}
        ${!ctx && !customCtx ? '<span style="font-size:12px;color:var(--gray)">(pas de contexte spécifique — prompts standards)</span>' : ''}
      </div>
      ${ctx || customCtx ? `
      <details>
        <summary style="cursor:pointer;font-size:12px;font-weight:700;color:var(--green);padding:4px 0;user-select:none">✏️ Voir / modifier le contexte</summary>
        <div style="margin-top:10px">
          <textarea class="form-input" id="sp-ctx_${t}" style="font-size:12px;font-family:monospace;min-height:140px" placeholder="Laissez vide pour le contexte par défaut…">${esc(customCtx)}</textarea>
          <div style="margin-top:6px;padding:10px;background:var(--bg);border:1px solid var(--gray-border);border-radius:8px;font-size:11px;font-family:monospace;color:var(--gray);white-space:pre-wrap;max-height:150px;overflow-y:auto"><strong>Défaut :</strong>\n${esc(ctx)}</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-primary btn-sm" data-save-prompt="ctx_${t}">💾 Enregistrer</button>
            ${isCustom ? `<button class="btn btn-danger btn-sm" data-reset-prompt="ctx_${t}">↩ Réinitialiser</button>` : ''}
          </div>
        </div>
      </details>` : ''}
    </div>`;
    }).join('')}
  </div>

</div>`;
}

// ─── MAIN RENDER ─────────────────────────────────────────────────────────────
function render() {
  document.getElementById('sidebar').innerHTML = renderSidebar();
  let content = '';
  switch(state.page) {
    case 'home':          content = renderHome(); break;
    case 'settings':      content = renderSettings(); break;
    case 'comp-new':      content = renderCompNew(); break;
    case 'comp-progress': content = renderCompProgress(); break;
    case 'comp-review':   content = renderCompReview(); break;
    case 'comp-assemble':   content = renderCompAssemble(); break;
    case 'comp-view':       content = renderCompView(); break;
    case 'steps-prompts':   content = renderStepsPrompts(); break;
    default:              content = renderHome();
  }
  document.getElementById('main').innerHTML = content;
  document.getElementById('modal-root').innerHTML = '';
  bind();
  // Restore scroll
  document.getElementById('main').scrollTop = 0;
  // Toast
  const toastEl = document.createElement('div');
  toastEl.innerHTML = renderToast();
  if (toastEl.firstChild) document.body.appendChild(toastEl.firstChild);
}

// ─── BIND ─────────────────────────────────────────────────────────────────────
function bind() {
  // Page navigation
  document.querySelectorAll('[data-page]').forEach(el => {
    el.addEventListener('click', () => {
      const p = el.dataset.page;
      // Nettoyer le comp vide si on quitte comp-new sans rien avoir saisi
      if (state.page === 'comp-new' && p !== 'comp-new') {
        const cur = getComp();
        if (cur && !cur.titre && cur.produits.length === 0) {
          db.comparatifs = db.comparatifs.filter(c => c.id !== cur.id);
          saveDB();
        }
      }
      if (p === 'comp-new') { state.compId = null; }
      state.page = p; render();
    });
  });

  // Home actions
  document.querySelectorAll('[data-action="open-comp"]').forEach(el => {
    el.addEventListener('click', () => {
      state.compId = parseInt(el.dataset.compId);
      state.page = 'comp-view'; render();
    });
  });
  document.querySelectorAll('[data-action="continue-comp"]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      const id = parseInt(el.dataset.compId);
      const comp = db.comparatifs.find(c => c.id === id);
      state.compId = id;
      if (comp.status === 'draft') state.page = 'comp-new';
      else if (comp.status === 'review') { state.page = 'comp-review'; state.reviewTab = 0; }
      else if (comp.status === 'ready' || comp.status === 'published') state.page = 'comp-assemble';
      else state.page = 'comp-view';
      render();
    });
  });
  document.querySelectorAll('[data-action="delete-comp"]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      if (!confirm('Supprimer ce comparatif ?')) return;
      db.comparatifs = db.comparatifs.filter(c => c.id !== parseInt(el.dataset.compId));
      saveDB(); render();
    });
  });

  // Settings
  const saveApiBtn = document.getElementById('s-save-api');
  if (saveApiBtn) saveApiBtn.addEventListener('click', () => {
    db.apiKey = document.getElementById('s-apikey').value.trim();
    saveDB(); showToast('Clé API enregistrée !');
  });
  document.querySelectorAll('[data-save-wp]').forEach(el => {
    el.addEventListener('click', () => {
      const site = el.dataset.saveWp;
      const prefix = site === 'Run Evasion' ? 're' : 'et';
      if (!db.wpCreds) db.wpCreds = {};
      db.wpCreds[site] = {
        user: document.getElementById(`s-wp-${prefix}-user`).value.trim(),
        password: document.getElementById(`s-wp-${prefix}-pass`).value.trim()
      };
      saveDB(); showToast(`WordPress ${site} enregistré !`);
    });
  });

  // Comp New
  const saveinfoBtn = document.getElementById('cn-save-info');
  if (saveinfoBtn) saveinfoBtn.addEventListener('click', () => {
    const comp = getComp(); if (!comp) return;
    comp.titre = document.getElementById('cn-titre').value.trim();
    comp.thematique = document.getElementById('cn-thematique').value;
    comp.targetSite = document.getElementById('cn-site').value;
    saveDB(); showToast('Informations enregistrées !');
  });
  // Auto-save titre on blur
  const titreInput = document.getElementById('cn-titre');
  if (titreInput) titreInput.addEventListener('blur', () => {
    const comp = getComp(); if (!comp) return;
    const v = titreInput.value.trim();
    if (v && v !== comp.titre) { comp.titre = v; saveDB(); }
  });

  const dlCsvBtn = document.getElementById('cn-dl-csv');
  if (dlCsvBtn) dlCsvBtn.addEventListener('click', downloadCSVTemplate);

  const addProdBtn = document.getElementById('cn-add-product');
  if (addProdBtn) addProdBtn.addEventListener('click', () => {
    document.getElementById('modal-root').innerHTML = renderProductModal(null);
    bindModal();
  });

  document.querySelectorAll('[data-edit-pid]').forEach(el => {
    el.addEventListener('click', () => {
      document.getElementById('modal-root').innerHTML = renderProductModal(el.dataset.editPid);
      bindModal();
    });
  });

  document.querySelectorAll('[data-del-pid]').forEach(el => {
    el.addEventListener('click', () => {
      if (!confirm('Supprimer ce produit ?')) return;
      const comp = getComp(); if (!comp) return;
      comp.produits = comp.produits.filter(p => String(p.id) !== String(el.dataset.delPid));
      saveDB(); render();
    });
  });

  // CSV import
  const csvInput = document.getElementById('cn-csv-import');
  if (csvInput) csvInput.addEventListener('change', e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const lines = ev.target.result.split('\n').filter(l => l.trim());
        const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g,'').trim());
        const comp = getComp(); if (!comp) return;
        lines.slice(1).forEach(line => {
          const vals = line.match(/(".*?"|[^,]+)/g) || [];
          const obj = { id: uid(), usages: [] };
          headers.forEach((h,i) => {
            const v = (vals[i]||'').replace(/^"|"$/g,'').trim();
            if (h === 'usages') obj.usages = v.split('|').map(x=>x.trim()).filter(Boolean);
            else if (['prix','note','poids','drop'].includes(h)) obj[h] = parseFloat(v)||0;
            else obj[h] = v;
          });
          if (obj.nom) comp.produits.push(obj);
        });
        saveDB(); render(); showToast(`${lines.length-1} produits importés !`);
      } catch(err) { showToast('Erreur CSV : ' + err.message, 'err'); }
    };
    reader.readAsText(file);
  });

  // Launch generation
  const launchBtn = document.getElementById('cn-launch');
  if (launchBtn) launchBtn.addEventListener('click', () => {
    const comp = getComp(); if (!comp) return;
    if (!db.apiKey) { showToast('Configure ta clé API Claude dans Paramètres.', 'err'); return; }
    // Save current info first
    const titreEl = document.getElementById('cn-titre');
    if (titreEl && !comp.titre) comp.titre = titreEl.value.trim();
    if (!comp.titre) { showToast('Saisis un titre pour le comparatif.', 'err'); return; }
    comp.blocs = newBlocs(comp.produits);
    saveDB();
    state.page = 'comp-progress';
    state.stepStatus = Array(10).fill('pending');
    render();
    runCompSteps(comp.id);
  });

  // Reprendre génération
  const reprendreBtn = document.getElementById('btn-reprendre');
  if (reprendreBtn) reprendreBtn.addEventListener('click', () => {
    const comp = getComp(); if (!comp) return;
    if (!db.apiKey) { showToast('Clé API manquante.', 'err'); return; }
    state.generating = true;
    state.stepStatus = Array(10).fill('pending');
    comp.status = 'generating';
    render();
    runCompSteps(comp.id);
  });

  // Prompt save/reset/copy-default
  document.querySelectorAll('[data-save-prompt]').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.dataset.savePrompt;
      const ta = document.getElementById(`sp-${key}`);
      if (!ta) return;
      const val = ta.value.trim();
      if (!db.customPrompts) db.customPrompts = {};
      if (val) { db.customPrompts[key] = val; showToast('Prompt enregistré !'); }
      else { delete db.customPrompts[key]; showToast('Prompt réinitialisé (défaut utilisé).'); }
      saveDB(); render();
    });
  });
  document.querySelectorAll('[data-reset-prompt]').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.dataset.resetPrompt;
      if (!db.customPrompts) db.customPrompts = {};
      delete db.customPrompts[key];
      saveDB(); render(); showToast('Prompt réinitialisé !');
    });
  });
  document.querySelectorAll('[data-copy-default]').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.dataset.copyDefault;
      const ta = document.getElementById(`sp-${key}`);
      if (ta) { ta.value = getPromptDefaultText(key); ta.focus(); }
    });
  });

  // Drag & drop for product list
  bindDragDrop();

  // Review tabs
  document.querySelectorAll('[data-review-tab]').forEach(el => {
    el.addEventListener('click', () => { state.reviewTab = parseInt(el.dataset.reviewTab); render(); });
  });

  // View/validate blocs
  document.querySelectorAll('[data-view-bloc]').forEach(el => {
    el.addEventListener('click', () => {
      state.currentBlockKey = el.dataset.viewBloc;
      state.reviewTab = 1; render();
    });
  });
  document.querySelectorAll('[data-validate-bloc]').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.dataset.validateBloc;
      const comp = getComp(); if (!comp) return;
      // Save edited content if in editor
      if (state.reviewTab === 1) {
        const ta = document.getElementById('bloc-editor');
        if (ta) {
          const v = ta.value;
          setBlocHtml(comp, key, v);
        }
      }
      setBlocStatus(comp, key, 'validated');
      // Auto-ready si tous les blocs obligatoires sont validés
      const allGlobal = ['intro','tableau','educatif','conclusion','faq'].every(k => comp.blocs[k]?.status === 'validated');
      const allProd = comp.produits.every(p => ['fiches','paragraphes','cta'].every(t => comp.blocs[t]?.[p.id]?.status === 'validated'));
      if (allGlobal && allProd && comp.status === 'review') { comp.status = 'ready'; showToast('Tous les blocs validés — article prêt !'); }
      saveDB(); render();
    });
  });

  // Regen blocs
  document.querySelectorAll('[data-regen-bloc]').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.dataset.regenBloc;
      regenBloc(key);
    });
  });

  // Editor refresh
  const refreshBtn = document.getElementById('refresh-preview');
  if (refreshBtn) refreshBtn.addEventListener('click', () => {
    const ta = document.getElementById('bloc-editor');
    const frame = document.getElementById('bloc-preview');
    if (ta && frame) {
      const html = ta.value;
      const comp = getComp();
      if (comp) setBlocHtml(comp, state.currentBlockKey, html);
      saveDB();
      const content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{margin:16px;font-family:system-ui,sans-serif;font-size:14px}*{max-width:100%}</style></head><body>${html}</body></html>`;
      frame.srcdoc = content;
    }
  });

  // Go assemble from review
  const goAssembleBtn = document.getElementById('go-assemble');
  if (goAssembleBtn) goAssembleBtn.addEventListener('click', () => {
    state.page = 'comp-assemble'; render();
  });

  // Review back
  document.querySelectorAll('[data-review-back]').forEach(el => {
    el.addEventListener('click', () => { state.page = 'comp-review'; state.reviewTab = 0; render(); });
  });

  // Assemble page
  const copyWpBtn = document.getElementById('copy-wp');
  if (copyWpBtn) copyWpBtn.addEventListener('click', () => {
    const comp = getComp(); if (!comp) return;
    copyText(comp.articleAssemble || assembleComparatif(comp));
  });
  const pushReBtn = document.getElementById('push-re');
  if (pushReBtn) pushReBtn.addEventListener('click', () => {
    const comp = getComp(); if (!comp) return;
    pushCompToWordPress(comp, 'Run Evasion');
  });
  const exportHtmlBtn = document.getElementById('export-html');
  if (exportHtmlBtn) exportHtmlBtn.addEventListener('click', () => {
    const comp = getComp(); if (!comp) return;
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(comp.titre)}</title></head><body>${comp.articleAssemble}</body></html>`;
    downloadFile(html, comp.titre.replace(/\s+/g,'-').toLowerCase() + '.html');
  });
  const exportJsonBtn = document.getElementById('export-json');
  if (exportJsonBtn) exportJsonBtn.addEventListener('click', () => {
    const comp = getComp(); if (!comp) return;
    downloadFile(JSON.stringify(comp, null, 2), comp.titre.replace(/\s+/g,'-').toLowerCase() + '.json', 'application/json');
  });
  const previewDesktop = document.getElementById('preview-desktop');
  if (previewDesktop) previewDesktop.addEventListener('click', () => {
    const f = document.getElementById('full-preview');
    if (f) f.style.maxWidth = 'none';
  });
  const previewMobile = document.getElementById('preview-mobile');
  if (previewMobile) previewMobile.addEventListener('click', () => {
    const f = document.getElementById('full-preview');
    if (f) f.style.maxWidth = '390px';
  });

  // Comp view actions
  document.querySelectorAll('[data-action="go-review"]').forEach(el => {
    el.addEventListener('click', () => { state.page = 'comp-review'; state.reviewTab = 0; render(); });
  });
  document.querySelectorAll('[data-action="go-assemble"]').forEach(el => {
    el.addEventListener('click', () => { state.page = 'comp-assemble'; render(); });
  });

  // Maillage
  const saveArticlesBtn = document.getElementById('save-articles-internes');
  if (saveArticlesBtn) saveArticlesBtn.addEventListener('click', () => {
    const comp = getComp(); if (!comp) return;
    const lines = document.getElementById('articles-internes').value.split('\n').filter(l=>l.trim());
    comp.articlesInternes = lines.map(l => {
      const [url, titre] = l.split('|').map(s=>s.trim());
      return { url, titre: titre||url };
    });
    saveDB(); showToast('Articles internes enregistrés !');
  });

  document.querySelectorAll('[data-apply-maillage]').forEach(el => {
    el.addEventListener('click', () => {
      const comp = getComp(); if (!comp) return;
      const pid = parseInt(el.dataset.applyMaillage);
      const bloc = comp.blocs.maillage[pid]; if (!bloc) return;
      const phs = bloc.placeholders || {};
      document.querySelectorAll(`[data-pid="${pid}"]`).forEach(input => {
        const ph = input.dataset.ph;
        const val = input.value.trim();
        if (ph && val) {
          phs[ph] = val;
          bloc.html = bloc.html.replace(new RegExp(ph.replace(/[{}]/g,'\\$&'),'g'), val);
        }
      });
      bloc.placeholders = phs;
      bloc.status = 'edited';
      saveDB(); render();
      showToast('Maillage mis à jour !');
    });
  });

  document.querySelectorAll('[data-clean-maillage]').forEach(el => {
    el.addEventListener('click', () => {
      const comp = getComp(); if (!comp) return;
      const pid = parseInt(el.dataset.cleanMaillage);
      const bloc = comp.blocs.maillage[pid]; if (!bloc) return;
      bloc.html = bloc.html.replace(/<a[^>]*>\{\{[^}]+\}\}<\/a>/g, '');
      bloc.html = bloc.html.replace(/\{\{[^}]+\}\}/g, '');
      bloc.status = 'edited';
      saveDB(); render();
      showToast('Placeholders vides supprimés !');
    });
  });
}

function bindModal() {
  const closeModal = () => {
    document.getElementById('modal-root').innerHTML = '';
  };
  document.getElementById('close-product-modal')?.addEventListener('click', closeModal);
  document.getElementById('close-product-modal-2')?.addEventListener('click', closeModal);
  document.getElementById('product-modal')?.addEventListener('click', e => {
    if (e.target.id === 'product-modal') closeModal();
  });

  const saveBtn = document.getElementById('pm-save');
  if (saveBtn) saveBtn.addEventListener('click', () => {
    const comp = getComp(); if (!comp) return;
    const pid = document.getElementById('pm-pid').value;
    const isNew = saveBtn.dataset.isNew === 'true';
    const usages = [...document.querySelectorAll('[name="pm-usage"]:checked')].map(i => i.value);
    const data = {
      id: isNew ? uid() : pid,
      nom: document.getElementById('pm-nom').value.trim(),
      marque: document.getElementById('pm-marque').value,
      prix: parseFloat(document.getElementById('pm-prix').value)||0,
      note: parseFloat(document.getElementById('pm-note').value)||0,
      poids: parseFloat(document.getElementById('pm-poids').value)||0,
      drop: parseFloat(document.getElementById('pm-drop').value)||0,
      mousse: document.getElementById('pm-mousse').value.trim(),
      usages,
      pointFort1: document.getElementById('pm-pf1').value.trim(),
      pointFort2: document.getElementById('pm-pf2').value.trim(),
      pointFaible: document.getElementById('pm-pfail').value.trim(),
      urlImage: document.getElementById('pm-img').value.trim(),
      urlAffilie: document.getElementById('pm-aff').value.trim(),
      urlTest: document.getElementById('pm-test').value.trim(),
    };
    if (!data.nom || !data.marque) { showToast('Nom et marque obligatoires.', 'err'); return; }
    if (isNew) {
      comp.produits.push(data);
    } else {
      const idx = comp.produits.findIndex(p => p.id == pid);
      if (idx >= 0) comp.produits[idx] = data; else comp.produits.push(data);
    }
    saveDB(); closeModal(); render();
    showToast(isNew ? 'Produit ajouté !' : 'Produit mis à jour !');
  });
}

function bindDragDrop() {
  const list = document.getElementById('cn-product-list');
  if (!list) return;
  let dragged = null;
  list.querySelectorAll('.product-item[draggable]').forEach(item => {
    item.addEventListener('dragstart', () => { dragged = item; item.classList.add('dragging'); });
    item.addEventListener('dragend', () => { dragged = null; item.classList.remove('dragging'); });
    item.addEventListener('dragover', e => { e.preventDefault(); if (dragged && dragged !== item) {
      const rect = item.getBoundingClientRect();
      const mid = rect.top + rect.height / 2;
      if (e.clientY < mid) list.insertBefore(dragged, item);
      else list.insertBefore(dragged, item.nextSibling);
    }});
    item.addEventListener('drop', () => {
      const comp = getComp(); if (!comp) return;
      const newOrder = [...list.querySelectorAll('.product-item')].map(el => String(el.dataset.pid));
      comp.produits.sort((a,b) => newOrder.indexOf(String(a.id)) - newOrder.indexOf(String(b.id)));
      saveDB();
    });
  });
}

// ─── BLOC HELPERS ─────────────────────────────────────────────────────────────
function setBlocHtml(comp, key, html) {
  if (key.includes(':')) {
    const [type, pid] = key.split(':');
    if (comp.blocs[type]?.[parseInt(pid)]) {
      comp.blocs[type][parseInt(pid)].html = html;
      comp.blocs[type][parseInt(pid)].status = 'edited';
    }
  } else {
    if (comp.blocs[key]) { comp.blocs[key].html = html; comp.blocs[key].status = 'edited'; }
  }
}

function setBlocStatus(comp, key, status) {
  if (key.includes(':')) {
    const [type, pid] = key.split(':');
    if (comp.blocs[type]?.[parseInt(pid)]) comp.blocs[type][parseInt(pid)].status = status;
  } else {
    if (comp.blocs[key]) comp.blocs[key].status = status;
  }
}

async function regenBloc(key) {
  const comp = getComp(); if (!comp) return;
  if (!db.apiKey) { showToast('Clé API manquante.', 'err'); return; }
  const csv = produitsToCSV(comp.produits);
  const modeles = comp.produits.map(p => `${p.marque} ${p.nom}`).join(', ');
  const themCtx = db.customPrompts?.['ctx_' + comp.thematique] || THEMATIQUE_CONTEXT[comp.thematique] || '';
  const sys = callPrompt('sys', {}) + (themCtx ? '\n\n' + themCtx : '');
  setBlocStatus(comp, key, 'generating');
  saveDB(); render();
  try {
    let html = '';
    if (key.includes(':')) {
      const [type, pidStr] = key.split(':');
      const p = comp.produits.find(x => String(x.id) === pidStr);
      if (!p) throw new Error('Produit introuvable');
      const csvP = produitToCSV(p);
      const articles = (comp.articlesInternes||[]).map(a => `${a.titre} : ${a.url}`).join('\n');
      if (type === 'fiches') html = await callClaude(sys, callPrompt('p_fiche', {nom: p.nom, marque: p.marque, csv_produit: csvP, template_css: ''}));
      else if (type === 'paragraphes') html = await callClaude(sys, callPrompt('p_paragraphe', {nom: p.nom, marque: p.marque, csv_produit: csvP}));
      else if (type === 'maillage') html = await callClaude(sys, callPrompt('p_maillage', {nom: p.nom, marque: p.marque, articles}), 'claude-haiku-4-5');
      else if (type === 'images') html = genImageBlock(p);
      else if (type === 'cta') html = genCtaBlock(p);
    } else {
      if (key === 'intro') html = await callClaude(sys, callPrompt('p_intro', {titre: comp.titre, csv, nbProduits: comp.produits.length, nb: comp.produits.length}));
      else if (key === 'tableau') html = await callClaude(sys, callPrompt('p_tableau', {csv, template_css: TEMPLATE_TABLEAU_CSS}));
      else if (key === 'educatif') html = await callClaude(sys, callPrompt('p_educatif', {csv, modeles}));
      else if (key === 'conclusion') html = await callClaude(sys, callPrompt('p_conclusion', {csv}));
      else if (key === 'faq') html = await callClaude(sys, callPrompt('p_faq', {titre: comp.titre, modeles, template_css: TEMPLATE_FAQ_CSS}));
    }
    setBlocHtml(comp, key, html);
    setBlocStatus(comp, key, 'generated');
    saveDB(); render();
    showToast('Bloc régénéré !');
  } catch(e) {
    setBlocStatus(comp, key, 'error');
    saveDB(); render();
    showToast('Erreur : ' + e.message, 'err');
  }
}

// ─── INIT ─────────────────────────────────────────────────────────────────────
render();
</script>
</body>
</html>
